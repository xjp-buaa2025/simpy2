<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èˆªç©ºå‘åŠ¨æœºè£…é…æ’äº§ä»¿çœŸç³»ç»Ÿ - åŒ—äº¬èˆªç©ºèˆªå¤©å¤§å­¦</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-card: #1f2937;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-red: #ef4444;
            --accent-cyan: #06b6d4;
            --accent-pink: #ec4899;
            --accent-gray: #6b7280;
            --border-color: #374151;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-actions { display: flex; gap: 0.5rem; }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: var(--accent-green); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover { background: var(--border-color); }
        .btn-danger { background: var(--accent-red); color: white; }
        
        .tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        
        .tab:hover { color: var(--text-primary); }
        .tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 120px);
        }
        
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 1rem;
            overflow-y: auto;
            display: none;
        }
        
        .sidebar.visible { display: block; }
        
        .sidebar-section { margin-bottom: 1.5rem; }
        
        .sidebar-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            letter-spacing: 0.05em;
        }
        
        .toolbox-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: grab;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .toolbox-item:hover {
            border-color: var(--accent-blue);
            transform: translateX(4px);
        }
        
        .toolbox-item:active { cursor: grabbing; }
        
        .toolbox-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .toolbox-info h4 { font-size: 0.875rem; margin-bottom: 0.125rem; }
        .toolbox-info span { font-size: 0.75rem; color: var(--text-secondary); }
        
        .form-group { margin-bottom: 1rem; }
        
        .form-group label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.375rem;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .content {
            flex: 1;
            padding: 1rem;
            overflow: auto;
            position: relative;
        }
        
        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: block; }
        
        .canvas-container {
            background: var(--bg-card);
            border-radius: 12px;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        #processCanvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }
        
        .canvas-toolbar {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .card-title {
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .kpi-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.25rem;
            border-left: 4px solid var(--accent-blue);
        }
        
        .kpi-card.green { border-left-color: var(--accent-green); }
        .kpi-card.orange { border-left-color: var(--accent-orange); }
        .kpi-card.purple { border-left-color: var(--accent-purple); }
        .kpi-card.red { border-left-color: var(--accent-red); }
        .kpi-card.cyan { border-left-color: var(--accent-cyan); }
        
        .kpi-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .kpi-value { font-size: 1.75rem; font-weight: 700; }
        
        .kpi-unit {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-left: 0.25rem;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1rem;
        }
        
        .chart-container {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .chart-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .chart-header select {
            padding: 0.375rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.8rem;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .comparison-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .comparison-table tr:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .comparison-better { color: var(--accent-green); }
        .comparison-worse { color: var(--accent-red); }
        
        .gantt-section { margin-bottom: 2rem; }
        
        .gantt-section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .gantt-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 8px;
        }
        
        .gantt-controls select {
            padding: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
        }
        
        .gantt-container {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        /* ç”˜ç‰¹å›¾ä¸»ä½“wrapper - å®ç°å·¦ä¾§å›ºå®š+å³ä¾§åŒæ­¥æ»šåŠ¨ */
        .gantt-wrapper {
            display: flex;
            overflow: hidden;
        }
        
        /* å·¦ä¾§å›ºå®šåˆ— */
        .gantt-left {
            flex-shrink: 0;
            width: 120px;
            background: var(--bg-card);
            z-index: 2;
            border-right: 2px solid var(--border-color);
        }
        
        .gantt-left-header {
            height: 40px;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .gantt-left-body {
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* éšè—å·¦ä¾§æ»šåŠ¨æ¡ï¼Œé€šè¿‡JSåŒæ­¥æ»šåŠ¨ */
        .gantt-left-body::-webkit-scrollbar {
            display: none;
        }
        .gantt-left-body {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .gantt-left-row {
            height: 52px;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            font-weight: 600;
        }
        
        .gantt-left-row:nth-child(odd) { background: rgba(255,255,255,0.02); }
        .gantt-left-row:hover { background: rgba(59, 130, 246, 0.1); }
        
        /* å³ä¾§å¯æ»šåŠ¨åŒºåŸŸ */
        .gantt-right {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .gantt-right-inner {
            display: flex;
            flex-direction: column;
            min-width: max-content;
        }
        
        .gantt-header {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 600;
            height: 40px;
            flex-shrink: 0;
        }
        
        .gantt-timeline {
            display: flex;
        }
        
        .gantt-time-cell {
            padding: 0.75rem 0.25rem;
            text-align: center;
            border-right: 1px solid var(--border-color);
            font-size: 0.7rem;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .gantt-time-cell.day-start {
            border-left: 2px solid var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .gantt-body {
            max-height: 500px;
            overflow-y: auto;
            width: fit-content;
            min-width: 100%;
        }
        
        /* ===== ä¼˜åŒ–åçš„ç”˜ç‰¹å›¾è¡Œæ ·å¼ - å¢å¤§è¡Œé«˜ ===== */
        .gantt-row {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            height: 52px;
            width: fit-content;
            min-width: 100%;
        }
        
        .gantt-row:nth-child(odd) { background: rgba(255,255,255,0.02); }
        .gantt-row:hover { background: rgba(59, 130, 246, 0.1); }
        
        .gantt-row-content {
            position: relative;
            display: flex;
            align-items: center;
            padding: 4px 0;
            height: 100%;
            flex-shrink: 0;
        }
        
        /* ===== ä¼˜åŒ–åçš„ç”˜ç‰¹å›¾æ¡å½¢æ ·å¼ - å¢å¤§é«˜åº¦ ===== */
        .gantt-bar {
            position: absolute;
            height: 38px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .gantt-bar:hover {
            transform: scaleY(1.1);
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        .gantt-bar.normal { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .gantt-bar.rest { background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%); }
        .gantt-bar.rework { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            background-image: repeating-linear-gradient(45deg, transparent, transparent 4px, rgba(255,255,255,0.15) 4px, rgba(255,255,255,0.15) 8px), linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .gantt-bar.waiting { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        
        .gantt-legend {
            display: flex;
            gap: 2rem;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.85rem;
            background: var(--bg-secondary);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .legend-color {
            width: 28px;
            height: 18px;
            border-radius: 4px;
        }
        
        .legend-color.normal { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .legend-color.rest { background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%); }
        .legend-color.rework { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .legend-color.waiting { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            width: 500px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
        }
        
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 { font-size: 1.125rem; }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
        }
        
        .modal-body { padding: 1.5rem; }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .equipment-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .equipment-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-card);
            border-radius: 6px;
        }
        
        .equipment-item input {
            flex: 1;
            padding: 0.375rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
        }
        
        .equipment-item input[type="number"] { width: 60px; flex: none; }
        
        .watermark {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            text-align: right;
            opacity: 0.3;
            pointer-events: none;
            z-index: 1;
        }
        
        .watermark-line {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
        }
        
        .loading.active { display: flex; }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 300;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .toast {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            animation: slideIn 0.3s ease;
        }
        
        .toast.success { border-left: 4px solid var(--accent-green); }
        .toast.error { border-left: 4px solid var(--accent-red); }
        .toast.warning { border-left: 4px solid var(--accent-orange); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .sidebar { display: none !important; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>ğŸ›« èˆªç©ºå‘åŠ¨æœºè£…é…æ’äº§ä»¿çœŸç³»ç»Ÿ</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="importCSV()">ğŸ“¥ å¯¼å…¥CSV</button>
            <button class="btn btn-secondary" onclick="exportCSV()">ğŸ“¤ å¯¼å‡ºCSV</button>
            <button class="btn btn-success" onclick="runSimulation()">â–¶ï¸ è¿è¡Œä»¿çœŸ</button>
        </div>
    </header>
    
    <div class="tabs">
        <div class="tab active" data-tab="editor">ğŸ“ æµç¨‹ç¼–è¾‘</div>
        <div class="tab" data-tab="config">âš™ï¸ å‚æ•°é…ç½®</div>
        <div class="tab" data-tab="results">ğŸ“Š ä»¿çœŸç»“æœ</div>
        <div class="tab" data-tab="gantt">ğŸ“… ç”˜ç‰¹å›¾</div>
    </div>
    
    <div class="main-container">
        <aside class="sidebar visible" id="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">ğŸ§° èŠ‚ç‚¹å·¥å…·ç®±</div>
                <div class="toolbox-item" draggable="true" data-type="H">
                    <div class="toolbox-icon" style="background: #3b82f6;">ğŸ“¦</div>
                    <div class="toolbox-info">
                        <h4>å–/æ”¾ (H)</h4>
                        <span>Handling</span>
                    </div>
                </div>
                <div class="toolbox-item" draggable="true" data-type="A">
                    <div class="toolbox-icon" style="background: #10b981;">ğŸ”§</div>
                    <div class="toolbox-info">
                        <h4>è£…é… (A)</h4>
                        <span>Assembly</span>
                    </div>
                </div>
                <div class="toolbox-item" draggable="true" data-type="M">
                    <div class="toolbox-icon" style="background: #f59e0b;">ğŸ“</div>
                    <div class="toolbox-info">
                        <h4>æµ‹é‡ (M)</h4>
                        <span>Measurement</span>
                    </div>
                </div>
                <div class="toolbox-item" draggable="true" data-type="T">
                    <div class="toolbox-icon" style="background: #8b5cf6;">ğŸ› ï¸</div>
                    <div class="toolbox-info">
                        <h4>å·¥å…·æ“ä½œ (T)</h4>
                        <span>Tooling</span>
                    </div>
                </div>
                <div class="toolbox-item" draggable="true" data-type="D">
                    <div class="toolbox-icon" style="background: #6b7280;">ğŸ“</div>
                    <div class="toolbox-info">
                        <h4>æ•°æ®è®°å½• (D)</h4>
                        <span>Data Recording</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">ğŸ“‹ æ“ä½œè¯´æ˜</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.6;">
                    <p>â€¢ æ‹–æ‹½èŠ‚ç‚¹åˆ°ç”»å¸ƒåˆ›å»º</p>
                    <p>â€¢ åŒå‡»èŠ‚ç‚¹ç¼–è¾‘å±æ€§</p>
                    <p>â€¢ <b>å³é”®æ‹–æ‹½åˆ›å»ºè¿çº¿</b></p>
                    <p>â€¢ Deleteé”®åˆ é™¤é€‰ä¸­</p>
                    <p>â€¢ æ»šè½®ç¼©æ”¾ç”»å¸ƒ</p>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">ğŸ“Š æµç¨‹ç»Ÿè®¡</div>
                <div id="processStats" style="font-size: 0.875rem;">
                    <p>èŠ‚ç‚¹æ•°: <span id="nodeCount">0</span></p>
                    <p>è¿çº¿æ•°: <span id="edgeCount">0</span></p>
                </div>
            </div>
        </aside>
        
        <main class="content">
            <!-- Tab: Editor -->
            <div id="tab-editor" class="tab-content active">
                <div class="canvas-container">
                    <div class="canvas-toolbar">
                        <button class="btn btn-secondary" onclick="autoLayout()">ğŸ”„ è‡ªåŠ¨å¸ƒå±€</button>
                        <button class="btn btn-secondary" onclick="clearCanvas()">ğŸ—‘ï¸ æ¸…ç©º</button>
                        <button class="btn btn-primary" onclick="loadComplexExample()">ğŸ“‹ åŠ è½½å¤æ‚ç¤ºä¾‹</button>
                    </div>
                    <canvas id="processCanvas"></canvas>
                </div>
            </div>
            
            <!-- Tab: Config -->
            <div id="tab-config" class="tab-content">
                <div class="card">
                    <h3 class="card-title">â° æ’ç­é…ç½®</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ¯æ—¥å·¥ä½œå°æ—¶æ•°</label>
                            <input type="number" id="workHoursPerDay" value="8" min="1" max="24">
                        </div>
                        <div class="form-group">
                            <label>æ¯æœˆå·¥ä½œå¤©æ•°</label>
                            <input type="number" id="workDaysPerMonth" value="22" min="1" max="31">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å·¥äººæ•°é‡</label>
                            <input type="number" id="numWorkers" value="8" min="1">
                        </div>
                        <div class="form-group">
                            <label>ç›®æ ‡æœˆäº§é‡ï¼ˆå°ï¼‰</label>
                            <input type="number" id="targetOutput" value="3" min="1">
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">ğŸ”§ å…³é”®è®¾å¤‡é…ç½®</h3>
                    <div id="equipmentList" class="equipment-list"></div>
                    <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="addEquipment()">â• æ·»åŠ è®¾å¤‡</button>
                </div>
                
                <div class="card">
                    <h3 class="card-title">ğŸ˜´ ä¼‘æ¯è§„åˆ™é…ç½®</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>è¿ç»­å·¥ä½œè§¦å‘é˜ˆå€¼ï¼ˆåˆ†é’Ÿï¼‰</label>
                            <input type="number" id="restTimeThreshold" value="50" min="1">
                        </div>
                        <div class="form-group">
                            <label>æ—¶é—´è§¦å‘ä¼‘æ¯æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                            <input type="number" id="restDurationTime" value="5" min="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>è´Ÿè·è§¦å‘é˜ˆå€¼ï¼ˆREBA 1-10ï¼‰</label>
                            <input type="number" id="restLoadThreshold" value="7" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label>è´Ÿè·è§¦å‘ä¼‘æ¯æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                            <input type="number" id="restDurationLoad" value="3" min="1">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Results -->
            <div id="tab-results" class="tab-content">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">æœˆäº§é‡</div>
                        <div class="kpi-value"><span id="kpiEngines">-</span><span class="kpi-unit">å°</span></div>
                    </div>
                    <div class="kpi-card green">
                        <div class="kpi-label">è®¡åˆ’è¾¾æˆç‡</div>
                        <div class="kpi-value"><span id="kpiAchievement">-</span><span class="kpi-unit">%</span></div>
                    </div>
                    <div class="kpi-card orange">
                        <div class="kpi-label">å¹³å‡å‘¨æœŸæ—¶é—´</div>
                        <div class="kpi-value"><span id="kpiCycleTime">-</span><span class="kpi-unit">å°æ—¶</span></div>
                    </div>
                    <div class="kpi-card purple">
                        <div class="kpi-label">ä¸€æ¬¡é€šè¿‡ç‡</div>
                        <div class="kpi-value"><span id="kpiPassRate">-</span><span class="kpi-unit">%</span></div>
                    </div>
                    <div class="kpi-card red">
                        <div class="kpi-label">æ€»ä¼‘æ¯æ—¶é—´</div>
                        <div class="kpi-value"><span id="kpiRestTime">-</span><span class="kpi-unit">åˆ†é’Ÿ</span></div>
                    </div>
                    <div class="kpi-card cyan">
                        <div class="kpi-label">é«˜å¼ºåº¦ä»»åŠ¡æš´éœ²</div>
                        <div class="kpi-value"><span id="kpiHighIntensity">-</span><span class="kpi-unit">æ¬¡</span></div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">ğŸ”„ äººå› å½±å“å¯¹æ¯”ï¼ˆè€ƒè™‘ä¼‘æ¯ vs ä¸è€ƒè™‘ä¼‘æ¯ï¼‰</h3>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>æŒ‡æ ‡</th>
                                <th>è€ƒè™‘äººå› ï¼ˆæœ‰ä¼‘æ¯ï¼‰</th>
                                <th>ä¸è€ƒè™‘äººå› ï¼ˆæ— ä¼‘æ¯ï¼‰</th>
                                <th>å·®å¼‚</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonBody">
                            <tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">è¿è¡Œä»¿çœŸåæ˜¾ç¤ºå¯¹æ¯”æ•°æ®</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">ğŸ‘· å·¥äººåˆ©ç”¨ç‡ï¼ˆåˆ†é’Ÿï¼‰</div>
                        <canvas id="workerChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">ğŸ­ è®¾å¤‡åˆ©ç”¨ç‡ï¼ˆåˆ†é’Ÿï¼‰</div>
                        <canvas id="equipmentChart"></canvas>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 1rem;">
                    <div class="chart-header">
                        <h3 class="card-title" style="margin-bottom: 0;">ğŸ˜“ å·¥äººç–²åŠ³åº¦æ›²çº¿</h3>
                        <select id="fatigueWorkerSelect" onchange="updateFatigueChart()">
                            <option value="all">å…¨éƒ¨å·¥äºº</option>
                        </select>
                    </div>
                    <canvas id="fatigueChart" style="max-height: 300px;"></canvas>
                </div>
                
                <div class="card" style="margin-top: 1rem;">
                    <h3 class="card-title">ğŸ“ˆ è´¨é‡ç»Ÿè®¡</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">æ€»æ£€éªŒæ¬¡æ•°</div>
                            <div style="font-size: 1.5rem; font-weight: 600;" id="statInspections">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">æ€»è¿”å·¥æ¬¡æ•°</div>
                            <div style="font-size: 1.5rem; font-weight: 600; color: var(--accent-red);" id="statReworks">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">è¿”å·¥æ—¶é—´</div>
                            <div style="font-size: 1.5rem; font-weight: 600;" id="statReworkTime">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">ä»¿çœŸæ—¶é•¿</div>
                            <div style="font-size: 1.5rem; font-weight: 600;" id="statDuration">-</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Gantt -->
            <div id="tab-gantt" class="tab-content">
                <div class="gantt-controls">
                    <span>æ—¶é—´èŒƒå›´:</span>
                    <select id="ganttStartDay"></select>
                    <select id="ganttStartHour"></select>
                    <span>è‡³</span>
                    <select id="ganttEndDay"></select>
                    <select id="ganttEndHour"></select>
                    <button class="btn btn-primary" onclick="updateGantt()">ğŸ”„ åˆ·æ–°</button>
                    <button class="btn btn-secondary" onclick="exportGanttCSV()">ğŸ“¤ å¯¼å‡ºCSV</button>
                </div>
                
                <div class="gantt-section">
                    <div class="gantt-section-title">ğŸ­ ç”Ÿäº§è¿›åº¦ç”˜ç‰¹å›¾ï¼ˆæŒ‰å‘åŠ¨æœºï¼‰</div>
                    <div class="gantt-container" id="engineGanttContainer">
                        <div class="gantt-wrapper">
                            <div class="gantt-left">
                                <div class="gantt-left-header">å‘åŠ¨æœº</div>
                                <div class="gantt-left-body" id="engineGanttLabels"></div>
                            </div>
                            <div class="gantt-right" id="engineGanttRight">
                                <div class="gantt-right-inner">
                                    <div class="gantt-header">
                                        <div class="gantt-timeline" id="ganttTimeline"></div>
                                    </div>
                                    <div class="gantt-body" id="ganttBody"></div>
                                </div>
                            </div>
                        </div>
                        <div class="gantt-legend">
                            <div class="legend-item"><div class="legend-color normal"></div><span>æ­£å¸¸å·¥ä½œ</span></div>
                            <div class="legend-item"><div class="legend-color rest"></div><span>ä¼‘æ¯</span></div>
                            <div class="legend-item"><div class="legend-color rework"></div><span>è¿”å·¥</span></div>
                            <div class="legend-item"><div class="legend-color waiting"></div><span>ç­‰å¾…èµ„æº</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="gantt-section">
                    <div class="gantt-section-title">ğŸ‘· å·¥äººæ’äº§ç”˜ç‰¹å›¾ï¼ˆæŒ‰å·¥äººï¼‰</div>
                    <div class="gantt-container" id="workerGanttContainer">
                        <div class="gantt-wrapper">
                            <div class="gantt-left">
                                <div class="gantt-left-header">å·¥äºº</div>
                                <div class="gantt-left-body" id="workerGanttLabels"></div>
                            </div>
                            <div class="gantt-right" id="workerGanttRight">
                                <div class="gantt-right-inner">
                                    <div class="gantt-header">
                                        <div class="gantt-timeline" id="workerGanttTimeline"></div>
                                    </div>
                                    <div class="gantt-body" id="workerGanttBody"></div>
                                </div>
                            </div>
                        </div>
                        <div class="gantt-legend">
                            <div class="legend-item"><div class="legend-color normal"></div><span>å·¥ä½œä¸­</span></div>
                            <div class="legend-item"><div class="legend-color rest"></div><span>ä¼‘æ¯ä¸­</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Node Edit Modal -->
    <div class="modal-overlay" id="nodeModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ“ ç¼–è¾‘èŠ‚ç‚¹å±æ€§</h3>
                <button class="modal-close" onclick="closeNodeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>æ­¥éª¤ID *</label>
                        <input type="text" id="nodeStepId" placeholder="å¦‚: S001">
                    </div>
                    <div class="form-group">
                        <label>æ“ä½œç±»å‹ *</label>
                        <select id="nodeOpType">
                            <option value="H">H - å–/æ”¾</option>
                            <option value="A">A - è£…é…</option>
                            <option value="M">M - æµ‹é‡</option>
                            <option value="T">T - å·¥å…·æ“ä½œ</option>
                            <option value="D">D - æ•°æ®è®°å½•</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>ä»»åŠ¡åç§° *</label>
                    <input type="text" id="nodeTaskName" placeholder="å¦‚: ä½å‹å‹æ°”æœºè£…é…">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ ‡å‡†å·¥æ—¶ï¼ˆåˆ†é’Ÿï¼‰</label>
                        <input type="number" id="nodeStdDuration" value="30" min="1">
                    </div>
                    <div class="form-group">
                        <label>æ—¶é—´æ–¹å·®</label>
                        <input type="number" id="nodeTimeVariance" value="5" min="0" step="0.1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>è´Ÿè·è¯„åˆ†ï¼ˆREBA 1-10ï¼‰</label>
                        <input type="number" id="nodeWorkLoad" value="5" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label>è¿”å·¥æ¦‚ç‡ï¼ˆä»…Mç±»å‹ï¼‰</label>
                        <input type="number" id="nodeReworkProb" value="0.05" min="0" max="1" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ‰€éœ€å·¥äººæ•°</label>
                        <input type="number" id="nodeWorkers" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>æ‰€éœ€å·¥å…·ï¼ˆåˆ†å·åˆ†éš”ï¼‰</label>
                        <input type="text" id="nodeTools" placeholder="å¦‚: åŠ¨å¹³è¡¡æœº;æ‰­åŠ›æ‰³æ‰‹">
                    </div>
                </div>
                <div class="form-group">
                    <label>å‰ç½®ä¾èµ–ï¼ˆåˆ†å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="nodePredecessors" placeholder="å¦‚: S001;S002">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeNodeModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="deleteNode()">åˆ é™¤èŠ‚ç‚¹</button>
                <button class="btn btn-primary" onclick="saveNode()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>æ­£åœ¨è¿è¡Œä»¿çœŸ...</div>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <div class="watermark">
        <div class="watermark-line">åŒ—äº¬èˆªç©ºèˆªå¤©å¤§å­¦</div>
        <div class="watermark-line">Beihang University</div>
    </div>
    
    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">

    <script>
        // ============================================================
        // å¤æ‚ç¤ºä¾‹æ•°æ® - å‹æ°”æœºè£…é…æµç¨‹ï¼ˆåŸºäºå®é™…å·¥è‰ºè¡¨ï¼‰
        // åŒ…å«5ä¸ªé˜¶æ®µï¼Œ65ä¸ªèŠ‚ç‚¹ï¼Œä½“ç°å¹¶è¡Œä½œä¸š
        // ============================================================
        const COMPLEX_PROCESS_NODES = [
            // ========== é˜¶æ®µ0: å‡†å¤‡ä¸æ£€æµ‹ (å¹¶è¡Œ) ==========
            { step_id: 'P001', task_name: 'æ‰«ç æ”¶è´§', op_type: 'D', predecessors: '', std_duration: 10, time_variance: 2, work_load_score: 3, rework_prob: 0, required_workers: 1, required_tools: 'æ‰«ç æª' },
            { step_id: 'P002', task_name: 'ç›®è§†æ£€æµ‹è½¬å­', op_type: 'M', predecessors: 'P001', std_duration: 25, time_variance: 5, work_load_score: 4, rework_prob: 0.03, required_workers: 1, required_tools: 'æ£€æµ‹å°' },
            { step_id: 'P003', task_name: 'ç›®è§†æ£€æµ‹å¶ç‰‡', op_type: 'M', predecessors: 'P001', std_duration: 30, time_variance: 5, work_load_score: 4, rework_prob: 0.04, required_workers: 1, required_tools: 'æ£€æµ‹å°' },
            { step_id: 'P004', task_name: 'ç›®è§†æ£€æµ‹ä¸»è¦é›¶ä»¶', op_type: 'M', predecessors: 'P001', std_duration: 35, time_variance: 6, work_load_score: 5, rework_prob: 0.03, required_workers: 2, required_tools: 'æ£€æµ‹å°' },
            
            // ========== é˜¶æ®µ1: è½¬å­å¶ç‰‡å®‰è£… (3çº§è½¬å­å¹¶è¡Œ) ==========
            { step_id: 'S101', task_name: 'å›ºå®š1çº§è½¬å­ç›˜', op_type: 'T', predecessors: 'P002', std_duration: 20, time_variance: 3, work_load_score: 6, rework_prob: 0, required_workers: 2, required_tools: 'å¶ç‰‡å®‰è£…å¤¹å…·' },
            { step_id: 'S102', task_name: 'å®‰è£…1çº§å¶ç‰‡', op_type: 'A', predecessors: 'S101;P003', std_duration: 45, time_variance: 8, work_load_score: 7, rework_prob: 0, required_workers: 2, required_tools: 'æœºæ¢°å¼å‹å…¥å·¥å…·' },
            { step_id: 'S103', task_name: 'å›ºå®š2çº§è½¬å­ç›˜', op_type: 'T', predecessors: 'S102', std_duration: 20, time_variance: 3, work_load_score: 6, rework_prob: 0, required_workers: 2, required_tools: 'å¶ç‰‡å®‰è£…å¤¹å…·' },
            { step_id: 'S104', task_name: 'å®‰è£…2çº§å¶ç‰‡', op_type: 'A', predecessors: 'S103', std_duration: 45, time_variance: 8, work_load_score: 7, rework_prob: 0, required_workers: 2, required_tools: 'æœºæ¢°å¼å‹å…¥å·¥å…·' },
            { step_id: 'S105', task_name: 'å›ºå®š3çº§è½¬å­ç›˜', op_type: 'T', predecessors: 'S104', std_duration: 20, time_variance: 3, work_load_score: 6, rework_prob: 0, required_workers: 2, required_tools: 'å¶ç‰‡å®‰è£…å¤¹å…·' },
            { step_id: 'S106', task_name: 'å®‰è£…3çº§å¶ç‰‡', op_type: 'A', predecessors: 'S105', std_duration: 45, time_variance: 8, work_load_score: 7, rework_prob: 0, required_workers: 2, required_tools: 'æœºæ¢°å¼å‹å…¥å·¥å…·' },
            
            // ========== é˜¶æ®µ2: ç¬¬ä¸€çº§è½¬å­ç»„ä»¶è£…é…ä¸å¹³è¡¡ ==========
            { step_id: 'S201', task_name: 'å®‰è£…æŒ¡åœˆ', op_type: 'A', predecessors: 'S106', std_duration: 15, time_variance: 3, work_load_score: 5, rework_prob: 0, required_workers: 1, required_tools: '' },
            { step_id: 'S202', task_name: 'é“†æ¥å›ºå®š', op_type: 'A', predecessors: 'S201', std_duration: 25, time_variance: 4, work_load_score: 6, rework_prob: 0, required_workers: 2, required_tools: 'é“†é’‰æª' },
            { step_id: 'S203', task_name: 'å®‰è£…è”è½´å™¨', op_type: 'A', predecessors: 'S202', std_duration: 20, time_variance: 4, work_load_score: 5, rework_prob: 0, required_workers: 1, required_tools: '' },
            { step_id: 'S204', task_name: 'å®‰è£…é”€é’‰èºæ¯', op_type: 'A', predecessors: 'S203', std_duration: 18, time_variance: 3, work_load_score: 5, rework_prob: 0, required_workers: 1, required_tools: 'æ‰‹åŠ¨å·¥å…·' },
            { step_id: 'S205', task_name: 'åŠ çƒ­å¯†å°ä»¶', op_type: 'T', predecessors: 'S204', std_duration: 30, time_variance: 5, work_load_score: 4, rework_prob: 0, required_workers: 1, required_tools: 'æ„Ÿåº”åŠ çƒ­å™¨' },
            { step_id: 'S206', task_name: 'å®‰è£…å¯†å°ä»¶', op_type: 'A', predecessors: 'S205', std_duration: 22, time_variance: 4, work_load_score: 6, rework_prob: 0, required_workers: 2, required_tools: 'ä¸“ç”¨å¥—ç­’' },
            { step_id: 'S207', task_name: 'å®‰è£…1å·è½´æ‰¿', op_type: 'A', predecessors: 'S206', std_duration: 28, time_variance: 5, work_load_score: 6, rework_prob: 0, required_workers: 2, required_tools: '' },
            { step_id: 'S208', task_name: 'å®‰è£…å«ç‰‡ä¸èºæ¯', op_type: 'A', predecessors: 'S207', std_duration: 15, time_variance: 3, work_load_score: 4, rework_prob: 0, required_workers: 1, required_tools: 'ä¸“ç”¨å¥—ç­’' },
            { step_id: 'S209', task_name: 'é¢„ç´§èºæ¯', op_type: 'T', predecessors: 'S208', std_duration: 20, time_variance: 4, work_load_score: 7, rework_prob: 0, required_workers: 1, required_tools: 'æ¶²å‹æ‹‰ä¼¸å™¨' },
            { step_id: 'S210', task_name: 'æœ€ç»ˆæ‹§ç´§', op_type: 'T', predecessors: 'S209', std_duration: 18, time_variance: 3, work_load_score: 6, rework_prob: 0, required_workers: 1, required_tools: 'é«˜ç²¾åº¦æ‰­çŸ©æ‰³æ‰‹' },
            { step_id: 'S211', task_name: 'é”ç´§å«ç‰‡', op_type: 'T', predecessors: 'S210', std_duration: 12, time_variance: 2, work_load_score: 5, rework_prob: 0, required_workers: 1, required_tools: 'ä¸“ç”¨å¥—ç­’' },
            { step_id: 'S212', task_name: 'åŠ¨å¹³è¡¡å‡†å¤‡', op_type: 'T', predecessors: 'S211', std_duration: 25, time_variance: 4, work_load_score: 5, rework_prob: 0, required_workers: 2, required_tools: 'åŠ¨å¹³è¡¡æœº' },
            { step_id: 'S213', task_name: 'æ‰§è¡Œå¹³è¡¡æµ‹è¯•', op_type: 'M', predecessors: 'S212', std_duration: 45, time_variance: 8, work_load_score: 5, rework_prob: 0.08, required_workers: 2, required_tools: 'åŠ¨å¹³è¡¡æœº' },
            { step_id: 'S214', task_name: 'æ·»åŠ é…é‡', op_type: 'A', predecessors: 'S213', std_duration: 20, time_variance: 4, work_load_score: 5, rework_prob: 0, required_workers: 1, required_tools: 'æ‰‹åŠ¨å·¥å…·' },
            { step_id: 'S215', task_name: 'å¤æµ‹å¹³è¡¡', op_type: 'M', predecessors: 'S214', std_duration: 35, time_variance: 6, work_load_score: 5, rework_prob: 0.05, required_workers: 2, required_tools: 'åŠ¨å¹³è¡¡æœº' },
            { step_id: 'S216', task_name: 'æ‹†å¸ç»„ä»¶', op_type: 'T', predecessors: 'S215', std_duration: 15, time_variance: 3, work_load_score: 5, rework_prob: 0, required_workers: 1, required_tools: '' },
            
            // ========== é˜¶æ®µ3: æ ¸å¿ƒæœºåŒè½´è£…é… ==========
            { step_id: 'S301', task_name: 'å›ºå®šæ¶¡è½®è½´', op_type: 'A', predecessors: 'S216;P004', std_duration: 30, time_variance: 5, work_load_score: 7, rework_prob: 0, required_workers: 2, required_tools: 'ç›´ç«‹è£…é…å·¥è£…' },
            { step_id: 'S302', task_name: 'å®‰è£…å¯¼å‘å¥—', op_type: 'A', predecessors: 'S301', std_duration: 22, time_variance: 4, work_load_score: 5, rework_prob: 0, required_workers: 1, required_tools: '' },
            { step_id: 'S303', task_name: 'å®‰è£…å¶è½®', op_type: 'A', predecessors: 'S302', std_duration: 28, time_variance: 5, work_load_score: 6, rework_prob: 0, required_workers: 2, required_tools: '' },
            { step_id: 'S304', task_name: 'å®‰è£…è°ƒæ•´ç›˜', op_type: 'A', predecessors: 'S303', std_duration: 20, time_variance: 4, work_load_score: 5, rework_prob: 0, required_workers: 1, required_tools: '' },
            { step_id: 'S305', task_name: 'å®‰è£…å¯¼æµæœºåŒ£', op_type: 'A', predecessors: 'S304', std_duration: 25, time_variance: 4, work_load_score: 6, rework_prob: 0, required_workers: 2, required_tools: '' },
            { step_id: 'S306', task_name: 'å®‰è£…ä¸‰çº§å®šå­', op_type: 'A', predecessors: 'S305', std_duration: 30, time_variance: 5, work_load_score: 6, rework_prob: 0, required_workers: 2, required_tools: 'æ¶²å‹å‹è£…å™¨' },
            { step_id: 'S307', task_name: 'æµ‹é‡å¶å°–é—´éš™', op_type: 'M', predecessors: 'S306', std_duration: 25, time_variance: 4, work_load_score: 4, rework_prob: 0.06, required_workers: 1, required_tools: 'å¡å°º' },
            { step_id: 'S308', task_name: 'å®‰è£…è¿æ¥èºæ “', op_type: 'A', predecessors: 'S307', std_duration: 20, time_variance: 3, work_load_score: 5, rework_prob: 0, required_workers: 1, required_tools: 'æ‰‹åŠ¨å·¥å…·' },
            { step_id: 'S309', task_name: 'æ‹§ç´§èºæ “', op_type: 'T', predecessors: 'S308', std_duration: 18, time_variance: 3, work_load_score: 6, rework_prob: 0, required_workers: 1, required_tools: 'æ™ºèƒ½æ‰­çŸ©æ‰³æ‰‹' },
            { step_id: 'S310', task_name: 'å®‰è£…ä¸‰çº§è½¬å­', op_type: 'A', predecessors: 'S309', std_duration: 35, time_variance: 6, work_load_score: 7, rework_prob: 0, required_workers: 2, required_tools: '' },
            { step_id: 'S311', task_name: 'æµ‹é‡è½´å‘é—´éš™', op_type: 'M', predecessors: 'S310', std_duration: 22, time_variance: 4, work_load_score: 4, rework_prob: 0.05, required_workers: 1, required_tools: 'å¡å°º' },
            { step_id: 'S312', task_name: 'æµ‹é‡å¶å°–é—´éš™2', op_type: 'M', predecessors: 'S311', std_duration: 22, time_variance: 4, work_load_score: 4, rework_prob: 0.05, required_workers: 1, required_tools: 'å¡å°º' },
            { step_id: 'S313', task_name: 'å®‰è£…äºŒçº§å®šå­', op_type: 'A', predecessors: 'S312', std_duration: 28, time_variance: 5, work_load_score: 6, rework_prob: 0, required_workers: 2, required_tools: '' },
            { step_id: 'S314', task_name: 'å®‰è£…äºŒçº§è½¬å­', op_type: 'A', predecessors: 'S313', std_duration: 32, time_variance: 5, work_load_score: 7, rework_prob: 0, required_workers: 2, required_tools: '' },
            { step_id: 'S315', task_name: 'æµ‹é‡å¶å°–é—´éš™3', op_type: 'M', predecessors: 'S314', std_duration: 22, time_variance: 4, work_load_score: 4, rework_prob: 0.05, required_workers: 1, required_tools: 'å¡å°º' },
            { step_id: 'S316', task_name: 'æµ‹é‡è½´å‘é—´éš™2', op_type: 'M', predecessors: 'S315', std_duration: 20, time_variance: 4, work_load_score: 4, rework_prob: 0.05, required_workers: 1, required_tools: 'å¡å°º' },
            { step_id: 'S317', task_name: 'å®‰è£…ä¸€çº§å®šå­', op_type: 'A', predecessors: 'S316', std_duration: 25, time_variance: 4, work_load_score: 6, rework_prob: 0, required_workers: 2, required_tools: '' },
            { step_id: 'S318', task_name: 'å®‰è£…è¿æ¥èºæ¯', op_type: 'A', predecessors: 'S317', std_duration: 18, time_variance: 3, work_load_score: 5, rework_prob: 0, required_workers: 1, required_tools: 'æ‰‹åŠ¨å·¥å…·' },
            { step_id: 'S319', task_name: 'æ‹§ç´§èºæ¯', op_type: 'T', predecessors: 'S318', std_duration: 16, time_variance: 3, work_load_score: 6, rework_prob: 0, required_workers: 1, required_tools: 'æ™ºèƒ½æ‰­çŸ©æ‰³æ‰‹' },
            { step_id: 'S320', task_name: 'å®‰è£…ä¸€çº§è½¬å­ç»„ä»¶', op_type: 'A', predecessors: 'S319', std_duration: 40, time_variance: 7, work_load_score: 7, rework_prob: 0, required_workers: 2, required_tools: '' },
            { step_id: 'S321', task_name: 'æµ‹é‡å¶å°–é—´éš™4', op_type: 'M', predecessors: 'S320', std_duration: 22, time_variance: 4, work_load_score: 4, rework_prob: 0.05, required_workers: 1, required_tools: 'å¡å°º' },
            { step_id: 'S322', task_name: 'æµ‹é‡è½´å‘é—´éš™3', op_type: 'M', predecessors: 'S321', std_duration: 20, time_variance: 4, work_load_score: 4, rework_prob: 0.05, required_workers: 1, required_tools: 'å¡å°º' },
            { step_id: 'S323', task_name: 'æ’å…¥è¿æ¥æ†', op_type: 'A', predecessors: 'S322', std_duration: 18, time_variance: 3, work_load_score: 5, rework_prob: 0, required_workers: 1, required_tools: '' },
            { step_id: 'S324', task_name: 'ç§»é™¤å¯¼å‘å¥—', op_type: 'T', predecessors: 'S323', std_duration: 12, time_variance: 2, work_load_score: 4, rework_prob: 0, required_workers: 1, required_tools: '' },
            { step_id: 'S325', task_name: 'å®‰è£…å«åœˆèºæ¯', op_type: 'A', predecessors: 'S324', std_duration: 15, time_variance: 3, work_load_score: 5, rework_prob: 0, required_workers: 1, required_tools: 'æ‰‹åŠ¨å·¥å…·' },
            { step_id: 'S326', task_name: 'é¢„ç´§è¿æ¥æ†', op_type: 'T', predecessors: 'S325', std_duration: 20, time_variance: 4, work_load_score: 7, rework_prob: 0, required_workers: 1, required_tools: 'æ¶²å‹æ‹‰ä¼¸å™¨' },
            { step_id: 'S327', task_name: 'æœ€ç»ˆæ‹§ç´§2', op_type: 'T', predecessors: 'S326', std_duration: 18, time_variance: 3, work_load_score: 6, rework_prob: 0, required_workers: 1, required_tools: 'é«˜ç²¾åº¦æ‰­çŸ©æ‰³æ‰‹' },
            
            // ========== é˜¶æ®µ4: æ•´ä½“åŠ¨å¹³è¡¡è°ƒè¯• ==========
            { step_id: 'S401', task_name: 'æµ‹é‡æ€»è·³åŠ¨', op_type: 'M', predecessors: 'S327', std_duration: 35, time_variance: 6, work_load_score: 5, rework_prob: 0.06, required_workers: 2, required_tools: 'ç™¾åˆ†è¡¨;ç£åŠ›è¡¨åº§' },
            { step_id: 'S402', task_name: 'ç¿»è½¬ç»„ä»¶', op_type: 'T', predecessors: 'S401', std_duration: 25, time_variance: 4, work_load_score: 8, rework_prob: 0, required_workers: 3, required_tools: 'èµ·é‡è®¾å¤‡' },
            { step_id: 'S403', task_name: 'åŠ çƒ­å¯†å°ä»¶2', op_type: 'T', predecessors: 'S402', std_duration: 28, time_variance: 5, work_load_score: 4, rework_prob: 0, required_workers: 1, required_tools: 'æ„Ÿåº”åŠ çƒ­å™¨' },
            { step_id: 'S404', task_name: 'å®‰è£…å¯†å°ä»¶2', op_type: 'A', predecessors: 'S403', std_duration: 22, time_variance: 4, work_load_score: 6, rework_prob: 0, required_workers: 2, required_tools: 'ä¸“ç”¨å¥—ç­’' },
            { step_id: 'S405', task_name: 'å®‰è£…2å·è½´æ‰¿', op_type: 'A', predecessors: 'S404', std_duration: 30, time_variance: 5, work_load_score: 6, rework_prob: 0, required_workers: 2, required_tools: '' },
            { step_id: 'S406', task_name: 'åŠ¨å¹³è¡¡å‡†å¤‡2', op_type: 'T', predecessors: 'S405', std_duration: 30, time_variance: 5, work_load_score: 6, rework_prob: 0, required_workers: 2, required_tools: 'åŠ¨å¹³è¡¡æœº' },
            { step_id: 'S407', task_name: 'æ‰§è¡Œå¹³è¡¡æµ‹è¯•2', op_type: 'M', predecessors: 'S406', std_duration: 50, time_variance: 10, work_load_score: 5, rework_prob: 0.10, required_workers: 2, required_tools: 'åŠ¨å¹³è¡¡æœº' },
            { step_id: 'S408', task_name: 'æ·»åŠ é…é‡2', op_type: 'A', predecessors: 'S407', std_duration: 25, time_variance: 5, work_load_score: 5, rework_prob: 0, required_workers: 1, required_tools: 'æ‰‹åŠ¨å·¥å…·' },
            { step_id: 'S409', task_name: 'å¤æµ‹å¹³è¡¡2', op_type: 'M', predecessors: 'S408', std_duration: 40, time_variance: 8, work_load_score: 5, rework_prob: 0.06, required_workers: 2, required_tools: 'åŠ¨å¹³è¡¡æœº' },
            { step_id: 'S410', task_name: 'æ‹†å¸æ€»æˆ', op_type: 'T', predecessors: 'S409', std_duration: 20, time_variance: 4, work_load_score: 6, rework_prob: 0, required_workers: 2, required_tools: '' },
            { step_id: 'S411', task_name: 'æ¸…æ´åŒ…è£…', op_type: 'T', predecessors: 'S410', std_duration: 30, time_variance: 5, work_load_score: 4, rework_prob: 0, required_workers: 2, required_tools: '' },
            { step_id: 'S412', task_name: 'æ‰«ç å‘è´§', op_type: 'D', predecessors: 'S411', std_duration: 10, time_variance: 2, work_load_score: 3, rework_prob: 0, required_workers: 1, required_tools: 'æ‰«ç æª;AGV' }
        ];
        
        // ============================================================
        // Global State
        // ============================================================
        const state = {
            nodes: [],
            edges: [],
            selectedNode: null,
            editingNode: null,
            simulationResult: null,
            config: {
                workHoursPerDay: 8,
                workDaysPerMonth: 22,
                numWorkers: 8,
                targetOutput: 3,
                criticalEquipment: {
                    'åŠ¨å¹³è¡¡æœº': 2,
                    'æ£€æµ‹å°': 2,
                    'å¶ç‰‡å®‰è£…å¤¹å…·': 3,
                    'æ¶²å‹æ‹‰ä¼¸å™¨': 2,
                    'æ„Ÿåº”åŠ çƒ­å™¨': 2,
                    'èµ·é‡è®¾å¤‡': 1
                },
                restTimeThreshold: 50,
                restDurationTime: 5,
                restLoadThreshold: 7,
                restDurationLoad: 3
            }
        };
        
        const OP_TYPE_COLORS = {
            'H': '#3b82f6', 'A': '#10b981', 'M': '#f59e0b', 'T': '#8b5cf6', 'D': '#6b7280'
        };
        
        const OP_TYPE_ICONS = {
            'H': 'ğŸ“¦', 'A': 'ğŸ”§', 'M': 'ğŸ“', 'T': 'ğŸ› ï¸', 'D': 'ğŸ“'
        };
        
        // ============================================================
        // Canvas Editor
        // ============================================================
        let canvas, ctx;
        let canvasOffset = { x: 0, y: 0 };
        let scale = 1;
        let isDragging = false;
        let isConnecting = false;
        let connectStart = null;
        let dragNode = null;
        let dragOffset = { x: 0, y: 0 };
        let lastMouseEvent = null;
        
        function initCanvas() {
            canvas = document.getElementById('processCanvas');
            ctx = canvas.getContext('2d');
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            canvas.addEventListener('mousedown', handleCanvasMouseDown);
            canvas.addEventListener('mousemove', handleCanvasMouseMove);
            canvas.addEventListener('mouseup', handleCanvasMouseUp);
            canvas.addEventListener('dblclick', handleCanvasDblClick);
            canvas.addEventListener('contextmenu', handleCanvasContextMenu);
            canvas.addEventListener('wheel', handleCanvasWheel);
            
            canvas.addEventListener('dragover', e => e.preventDefault());
            canvas.addEventListener('drop', handleCanvasDrop);
            
            document.addEventListener('keydown', handleKeyDown);
            
            renderCanvas();
        }
        
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            renderCanvas();
        }
        
        function renderCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(canvasOffset.x, canvasOffset.y);
            ctx.scale(scale, scale);
            
            drawGrid();
            
            state.edges.forEach(edge => {
                const fromNode = state.nodes.find(n => n.id === edge.from);
                const toNode = state.nodes.find(n => n.id === edge.to);
                if (fromNode && toNode) drawEdge(fromNode, toNode);
            });
            
            if (isConnecting && connectStart && lastMouseEvent) {
                const mousePos = getMousePos(lastMouseEvent);
                ctx.beginPath();
                ctx.moveTo(connectStart.x + 60, connectStart.y + 25);
                ctx.lineTo(mousePos.x, mousePos.y);
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            state.nodes.forEach(node => drawNode(node, node === state.selectedNode));
            
            ctx.restore();
            updateStats();
        }
        
        function drawGrid() {
            const gridSize = 20;
            ctx.strokeStyle = '#1f2937';
            ctx.lineWidth = 0.5;
            
            const startX = -canvasOffset.x / scale;
            const startY = -canvasOffset.y / scale;
            const endX = (canvas.width - canvasOffset.x) / scale;
            const endY = (canvas.height - canvasOffset.y) / scale;
            
            for (let x = Math.floor(startX / gridSize) * gridSize; x < endX; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, startY);
                ctx.lineTo(x, endY);
                ctx.stroke();
            }
            
            for (let y = Math.floor(startY / gridSize) * gridSize; y < endY; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(startX, y);
                ctx.lineTo(endX, y);
                ctx.stroke();
            }
        }
        
        function drawNode(node, selected) {
            const x = node.x;
            const y = node.y;
            const width = 120;
            const height = 50;
            
            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            
            ctx.fillStyle = OP_TYPE_COLORS[node.opType] || '#6b7280';
            ctx.beginPath();
            ctx.roundRect(x, y, width, height, 8);
            ctx.fill();
            
            ctx.shadowColor = 'transparent';
            
            if (selected) {
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();
            }
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`${OP_TYPE_ICONS[node.opType]} ${node.stepId}`, x + width/2, y + 20);
            
            ctx.font = '11px sans-serif';
            const displayName = node.taskName.length > 10 ? node.taskName.substring(0, 10) + '...' : node.taskName;
            ctx.fillText(displayName, x + width/2, y + 38);
        }
        
        function drawEdge(from, to) {
            const fromCenterX = from.x + 60;
            const fromCenterY = from.y + 25;
            const toCenterX = to.x + 60;
            const toCenterY = to.y + 25;
            
            let fromX, fromY, toX, toY;
            
            if (toCenterX > fromCenterX + 60) {
                fromX = from.x + 120;
                fromY = from.y + 25;
                toX = to.x;
                toY = to.y + 25;
            } else if (toCenterX < fromCenterX - 60) {
                fromX = from.x;
                fromY = from.y + 25;
                toX = to.x + 120;
                toY = to.y + 25;
            } else if (toCenterY > fromCenterY) {
                fromX = from.x + 60;
                fromY = from.y + 50;
                toX = to.x + 60;
                toY = to.y;
            } else {
                fromX = from.x + 60;
                fromY = from.y;
                toX = to.x + 60;
                toY = to.y + 50;
            }
            
            ctx.beginPath();
            ctx.moveTo(fromX, fromY);
            
            const cpX = (fromX + toX) / 2;
            const cpY = (fromY + toY) / 2;
            ctx.bezierCurveTo(cpX, fromY, cpX, toY, toX, toY);
            
            ctx.strokeStyle = '#4b5563';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            const angle = Math.atan2(toY - cpY, toX - cpX);
            ctx.beginPath();
            ctx.moveTo(toX, toY);
            ctx.lineTo(toX - 10 * Math.cos(angle - Math.PI/6), toY - 10 * Math.sin(angle - Math.PI/6));
            ctx.lineTo(toX - 10 * Math.cos(angle + Math.PI/6), toY - 10 * Math.sin(angle + Math.PI/6));
            ctx.closePath();
            ctx.fillStyle = '#4b5563';
            ctx.fill();
        }
        
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left - canvasOffset.x) / scale,
                y: (e.clientY - rect.top - canvasOffset.y) / scale
            };
        }
        
        function findNodeAt(pos) {
            return state.nodes.find(node => 
                pos.x >= node.x && pos.x <= node.x + 120 &&
                pos.y >= node.y && pos.y <= node.y + 50
            );
        }
        
        function handleCanvasMouseDown(e) {
            lastMouseEvent = e;
            const pos = getMousePos(e);
            const node = findNodeAt(pos);
            
            if (e.button === 2) {
                if (node) {
                    isConnecting = true;
                    connectStart = node;
                }
                return;
            }
            
            if (node) {
                state.selectedNode = node;
                dragNode = node;
                dragOffset = { x: pos.x - node.x, y: pos.y - node.y };
            } else {
                state.selectedNode = null;
                isDragging = true;
                dragOffset = { x: e.clientX - canvasOffset.x, y: e.clientY - canvasOffset.y };
            }
            
            renderCanvas();
        }
        
        function handleCanvasMouseMove(e) {
            lastMouseEvent = e;
            
            if (isDragging) {
                canvasOffset.x = e.clientX - dragOffset.x;
                canvasOffset.y = e.clientY - dragOffset.y;
                renderCanvas();
            } else if (dragNode) {
                const pos = getMousePos(e);
                dragNode.x = pos.x - dragOffset.x;
                dragNode.y = pos.y - dragOffset.y;
                renderCanvas();
            } else if (isConnecting) {
                renderCanvas();
            }
        }
        
        function handleCanvasMouseUp(e) {
            if (isConnecting && connectStart) {
                const pos = getMousePos(e);
                const targetNode = findNodeAt(pos);
                
                if (targetNode && targetNode !== connectStart) {
                    const existingEdge = state.edges.find(
                        edge => edge.from === connectStart.id && edge.to === targetNode.id
                    );
                    if (!existingEdge) {
                        state.edges.push({ from: connectStart.id, to: targetNode.id });
                        if (!targetNode.predecessors.includes(connectStart.stepId)) {
                            targetNode.predecessors = targetNode.predecessors 
                                ? targetNode.predecessors + ';' + connectStart.stepId 
                                : connectStart.stepId;
                        }
                        showToast(`å·²åˆ›å»ºè¿çº¿: ${connectStart.stepId} â†’ ${targetNode.stepId}`, 'success');
                    }
                }
            }
            
            isDragging = false;
            isConnecting = false;
            connectStart = null;
            dragNode = null;
            renderCanvas();
        }
        
        function handleCanvasDblClick(e) {
            const pos = getMousePos(e);
            const node = findNodeAt(pos);
            if (node) openNodeModal(node);
        }
        
        function handleCanvasContextMenu(e) { e.preventDefault(); }
        
        function handleCanvasWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            scale = Math.max(0.3, Math.min(2, scale * delta));
            renderCanvas();
        }
        
        function handleCanvasDrop(e) {
            e.preventDefault();
            const opType = e.dataTransfer.getData('text/plain');
            if (!opType) return;
            
            const pos = getMousePos(e);
            const nodeId = 'node_' + Date.now();
            const stepId = 'S' + String(state.nodes.length + 1).padStart(3, '0');
            
            const newNode = {
                id: nodeId,
                stepId: stepId,
                taskName: 'æ–°ä»»åŠ¡',
                opType: opType,
                predecessors: '',
                stdDuration: 30,
                timeVariance: 5,
                workLoadScore: 5,
                reworkProb: opType === 'M' ? 0.05 : 0,
                requiredWorkers: 1,
                requiredTools: '',
                x: pos.x - 60,
                y: pos.y - 25
            };
            
            state.nodes.push(newNode);
            state.selectedNode = newNode;
            renderCanvas();
            openNodeModal(newNode);
        }
        
        function handleKeyDown(e) {
            if (e.key === 'Delete' && state.selectedNode) deleteSelectedNode();
        }
        
        // ============================================================
        // Node Modal
        // ============================================================
        function openNodeModal(node) {
            state.editingNode = node;
            
            document.getElementById('nodeStepId').value = node.stepId;
            document.getElementById('nodeTaskName').value = node.taskName;
            document.getElementById('nodeOpType').value = node.opType;
            document.getElementById('nodeStdDuration').value = node.stdDuration;
            document.getElementById('nodeTimeVariance').value = node.timeVariance;
            document.getElementById('nodeWorkLoad').value = node.workLoadScore;
            document.getElementById('nodeReworkProb').value = node.reworkProb;
            document.getElementById('nodeWorkers').value = node.requiredWorkers;
            document.getElementById('nodeTools').value = node.requiredTools;
            document.getElementById('nodePredecessors').value = node.predecessors;
            
            document.getElementById('nodeModal').classList.add('active');
        }
        
        function closeNodeModal() {
            document.getElementById('nodeModal').classList.remove('active');
            state.editingNode = null;
        }
        
        function saveNode() {
            if (!state.editingNode) return;
            
            const node = state.editingNode;
            const oldStepId = node.stepId;
            const newStepId = document.getElementById('nodeStepId').value;
            
            node.stepId = newStepId;
            node.taskName = document.getElementById('nodeTaskName').value;
            node.opType = document.getElementById('nodeOpType').value;
            node.stdDuration = parseFloat(document.getElementById('nodeStdDuration').value) || 30;
            node.timeVariance = parseFloat(document.getElementById('nodeTimeVariance').value) || 0;
            node.workLoadScore = parseInt(document.getElementById('nodeWorkLoad').value) || 5;
            node.reworkProb = parseFloat(document.getElementById('nodeReworkProb').value) || 0;
            node.requiredWorkers = parseInt(document.getElementById('nodeWorkers').value) || 1;
            node.requiredTools = document.getElementById('nodeTools').value;
            node.predecessors = document.getElementById('nodePredecessors').value;
            
            if (oldStepId !== newStepId) {
                state.nodes.forEach(n => {
                    if (n.predecessors) {
                        n.predecessors = n.predecessors.split(';')
                            .map(p => p.trim() === oldStepId ? newStepId : p)
                            .join(';');
                    }
                });
            }
            
            rebuildEdges();
            closeNodeModal();
            renderCanvas();
            showToast('èŠ‚ç‚¹å·²ä¿å­˜', 'success');
        }
        
        function deleteNode() {
            if (!state.editingNode) return;
            
            const nodeId = state.editingNode.id;
            const stepId = state.editingNode.stepId;
            
            state.nodes = state.nodes.filter(n => n.id !== nodeId);
            state.edges = state.edges.filter(e => e.from !== nodeId && e.to !== nodeId);
            
            state.nodes.forEach(n => {
                if (n.predecessors) {
                    n.predecessors = n.predecessors.split(';')
                        .filter(p => p.trim() !== stepId)
                        .join(';');
                }
            });
            
            state.selectedNode = null;
            closeNodeModal();
            renderCanvas();
            showToast('èŠ‚ç‚¹å·²åˆ é™¤', 'success');
        }
        
        function deleteSelectedNode() {
            if (!state.selectedNode) return;
            state.editingNode = state.selectedNode;
            deleteNode();
        }
        
        function rebuildEdges() {
            state.edges = [];
            const stepIdToNodeId = {};
            state.nodes.forEach(n => stepIdToNodeId[n.stepId] = n.id);
            
            state.nodes.forEach(node => {
                if (node.predecessors) {
                    node.predecessors.split(';').forEach(pred => {
                        pred = pred.trim();
                        if (pred && stepIdToNodeId[pred]) {
                            state.edges.push({ from: stepIdToNodeId[pred], to: node.id });
                        }
                    });
                }
            });
        }
        
        // ============================================================
        // Canvas Actions
        // ============================================================
        function autoLayout() {
            const levels = {};
            const nodeMap = {};
            state.nodes.forEach(n => {
                nodeMap[n.stepId] = n;
                levels[n.stepId] = 0;
            });
            
            let changed = true;
            while (changed) {
                changed = false;
                state.nodes.forEach(node => {
                    if (node.predecessors) {
                        node.predecessors.split(';').forEach(pred => {
                            pred = pred.trim();
                            if (pred && levels[pred] !== undefined) {
                                const newLevel = levels[pred] + 1;
                                if (newLevel > levels[node.stepId]) {
                                    levels[node.stepId] = newLevel;
                                    changed = true;
                                }
                            }
                        });
                    }
                });
            }
            
            const levelGroups = {};
            Object.entries(levels).forEach(([stepId, level]) => {
                if (!levelGroups[level]) levelGroups[level] = [];
                levelGroups[level].push(stepId);
            });
            
            const startX = 50;
            const startY = 50;
            const xGap = 160;
            const yGap = 70;
            
            Object.entries(levelGroups).forEach(([level, stepIds]) => {
                stepIds.forEach((stepId, idx) => {
                    const node = nodeMap[stepId];
                    if (node) {
                        node.x = startX + parseInt(level) * xGap;
                        node.y = startY + idx * yGap;
                    }
                });
            });
            
            renderCanvas();
            showToast('è‡ªåŠ¨å¸ƒå±€å®Œæˆ', 'success');
        }
        
        function clearCanvas() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠ‚ç‚¹å—ï¼Ÿ')) return;
            state.nodes = [];
            state.edges = [];
            state.selectedNode = null;
            renderCanvas();
            showToast('ç”»å¸ƒå·²æ¸…ç©º', 'success');
        }
        
        function loadComplexExample() {
            loadProcessData({ name: 'å‹æ°”æœºè£…é…æµç¨‹', nodes: COMPLEX_PROCESS_NODES });
            
            document.getElementById('numWorkers').value = 8;
            document.getElementById('targetOutput').value = 3;
            document.getElementById('workDaysPerMonth').value = 22;
            
            state.config.criticalEquipment = {
                'åŠ¨å¹³è¡¡æœº': 2,
                'æ£€æµ‹å°': 2,
                'å¶ç‰‡å®‰è£…å¤¹å…·': 3,
                'æ¶²å‹æ‹‰ä¼¸å™¨': 2,
                'æ„Ÿåº”åŠ çƒ­å™¨': 2,
                'èµ·é‡è®¾å¤‡': 1
            };
            renderEquipmentList();
            
            showToast(`å¤æ‚ç¤ºä¾‹æµç¨‹å·²åŠ è½½ï¼ˆ${COMPLEX_PROCESS_NODES.length}ä¸ªèŠ‚ç‚¹ï¼Œé¢„è®¡æœˆäº§3å°ï¼‰`, 'success');
        }
        
        function loadProcessData(process) {
            state.nodes = process.nodes.map((n, idx) => ({
                id: 'node_' + idx,
                stepId: n.step_id,
                taskName: n.task_name,
                opType: n.op_type,
                predecessors: n.predecessors || '',
                stdDuration: n.std_duration,
                timeVariance: n.time_variance || 0,
                workLoadScore: n.work_load_score || 5,
                reworkProb: n.rework_prob || 0,
                requiredWorkers: n.required_workers || 1,
                requiredTools: Array.isArray(n.required_tools) ? n.required_tools.join(';') : (n.required_tools || ''),
                x: n.x || 50 + idx * 150,
                y: n.y || 100
            }));
            
            rebuildEdges();
            autoLayout();
        }
        
        // ============================================================
        // CSV Import/Export
        // ============================================================
        function importCSV() {
            document.getElementById('csvFileInput').click();
        }
        
        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/process/parse-csv', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    loadProcessData(data.data);
                    showToast('CSVå¯¼å…¥æˆåŠŸ', 'success');
                } else {
                    showToast(data.message || 'å¯¼å…¥å¤±è´¥', 'error');
                }
            })
            .catch(err => {
                showToast('å¯¼å…¥å¤±è´¥', 'error');
            });
            
            event.target.value = '';
        }
        
        function exportCSV() {
            const process = buildProcessDefinition();
            
            fetch('/api/process/export-csv', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(process)
            })
            .then(res => res.blob())
            .then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'process.csv';
                a.click();
                URL.revokeObjectURL(url);
                showToast('CSVå·²å¯¼å‡º', 'success');
            })
            .catch(err => {
                showToast('å¯¼å‡ºå¤±è´¥', 'error');
            });
        }
        
        function buildProcessDefinition() {
            return {
                name: 'å·¥è‰ºæµç¨‹',
                description: '',
                nodes: state.nodes.map(n => ({
                    step_id: n.stepId,
                    task_name: n.taskName,
                    op_type: n.opType,
                    predecessors: n.predecessors,
                    std_duration: n.stdDuration,
                    time_variance: n.timeVariance,
                    work_load_score: n.workLoadScore,
                    rework_prob: n.reworkProb,
                    required_workers: n.requiredWorkers,
                    required_tools: n.requiredTools ? n.requiredTools.split(';').map(t => t.trim()).filter(t => t) : [],
                    x: n.x,
                    y: n.y
                }))
            };
        }
        
        // ============================================================
        // Configuration
        // ============================================================
        function initConfig() {
            renderEquipmentList();
        }
        
        function getConfigFromUI() {
            return {
                work_hours_per_day: parseInt(document.getElementById('workHoursPerDay').value),
                work_days_per_month: parseInt(document.getElementById('workDaysPerMonth').value),
                num_workers: parseInt(document.getElementById('numWorkers').value),
                target_output: parseInt(document.getElementById('targetOutput').value),
                critical_equipment: state.config.criticalEquipment,
                rest_time_threshold: parseFloat(document.getElementById('restTimeThreshold').value),
                rest_duration_time: parseFloat(document.getElementById('restDurationTime').value),
                rest_load_threshold: parseInt(document.getElementById('restLoadThreshold').value),
                rest_duration_load: parseFloat(document.getElementById('restDurationLoad').value)
            };
        }
        
        function renderEquipmentList() {
            const container = document.getElementById('equipmentList');
            container.innerHTML = '';
            
            Object.entries(state.config.criticalEquipment).forEach(([name, count]) => {
                const item = document.createElement('div');
                item.className = 'equipment-item';
                item.innerHTML = `
                    <input type="text" value="${name}" onchange="updateEquipmentName(this, '${name}')">
                    <input type="number" value="${count}" min="1" onchange="updateEquipmentCount('${name}', this.value)">
                    <button class="btn btn-danger" onclick="removeEquipment('${name}')" style="padding: 0.25rem 0.5rem;">âœ•</button>
                `;
                container.appendChild(item);
            });
        }
        
        function addEquipment() {
            const name = prompt('è¯·è¾“å…¥è®¾å¤‡åç§°:');
            if (name && !state.config.criticalEquipment[name]) {
                state.config.criticalEquipment[name] = 1;
                renderEquipmentList();
            }
        }
        
        function updateEquipmentName(input, oldName) {
            const newName = input.value.trim();
            if (newName && newName !== oldName) {
                state.config.criticalEquipment[newName] = state.config.criticalEquipment[oldName];
                delete state.config.criticalEquipment[oldName];
                renderEquipmentList();
            }
        }
        
        function updateEquipmentCount(name, count) {
            state.config.criticalEquipment[name] = parseInt(count) || 1;
        }
        
        function removeEquipment(name) {
            delete state.config.criticalEquipment[name];
            renderEquipmentList();
        }
        
        // ============================================================
        // Simulation
        // ============================================================
        function runSimulation() {
            if (state.nodes.length === 0) {
                showToast('è¯·å…ˆæ·»åŠ å·¥è‰ºèŠ‚ç‚¹', 'warning');
                return;
            }
            
            const config = getConfigFromUI();
            const process = buildProcessDefinition();
            
            showLoading(true);
            
            fetch('/api/simulation/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ config, process })
            })
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    state.simulationResult = data.data;
                    updateResults(data.data);
                    switchTab('results');
                    showToast(data.message, 'success');
                } else {
                    showToast(data.message || 'ä»¿çœŸå¤±è´¥', 'error');
                }
            })
            .catch(err => {
                showLoading(false);
                console.error(err);
                showToast('ä»¿çœŸè¯·æ±‚å¤±è´¥', 'error');
            });
        }
        
        // ============================================================
        // Results Display
        // ============================================================
        let workerChart = null;
        let equipmentChart = null;
        let fatigueChart = null;
        
        function updateResults(result) {
            document.getElementById('kpiEngines').textContent = result.engines_completed;
            document.getElementById('kpiAchievement').textContent = (result.target_achievement_rate * 100).toFixed(1);
            document.getElementById('kpiCycleTime').textContent = (result.avg_cycle_time / 60).toFixed(1);
            document.getElementById('kpiPassRate').textContent = (result.quality_stats.first_pass_rate * 100).toFixed(1);
            
            const hfStats = result.human_factors_stats || {};
            document.getElementById('kpiRestTime').textContent = (hfStats.total_rest_time || 0).toFixed(0);
            document.getElementById('kpiHighIntensity').textContent = hfStats.total_high_intensity_exposure || 0;
            
            document.getElementById('statInspections').textContent = result.quality_stats.total_inspections;
            document.getElementById('statReworks').textContent = result.quality_stats.total_reworks;
            document.getElementById('statReworkTime').textContent = (result.quality_stats.rework_time_total || 0).toFixed(1) + 'åˆ†é’Ÿ';
            document.getElementById('statDuration').textContent = (result.sim_duration / 60).toFixed(1) + 'å°æ—¶';
            
            updateComparisonTable(result);
            
            const workerLabels = result.worker_stats.map(w => w.resource_id);
            const workerWork = result.worker_stats.map(w => w.work_time || 0);
            const workerRest = result.worker_stats.map(w => w.rest_time || 0);
            const workerIdle = result.worker_stats.map(w => Math.max(0, result.sim_duration - (w.work_time || 0) - (w.rest_time || 0)));
            
            if (workerChart) workerChart.destroy();
            workerChart = new Chart(document.getElementById('workerChart'), {
                type: 'bar',
                data: {
                    labels: workerLabels,
                    datasets: [
                        { label: 'å·¥ä½œ', data: workerWork, backgroundColor: '#3b82f6', borderRadius: 4 },
                        { label: 'ä¼‘æ¯', data: workerRest, backgroundColor: '#a855f7', borderRadius: 4 },
                        { label: 'ç©ºé—²', data: workerIdle, backgroundColor: '#374151', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { stacked: true, ticks: { color: '#9ca3af' }, grid: { color: '#374151' } },
                        y: { stacked: true, ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }
                    },
                    plugins: { legend: { labels: { color: '#9ca3af' } } }
                }
            });
            
            const equipLabels = result.equipment_stats.map(e => e.resource_id);
            const equipWork = result.equipment_stats.map(e => e.work_time || 0);
            const equipIdle = result.equipment_stats.map(e => Math.max(0, result.sim_duration - (e.work_time || 0)));
            
            if (equipmentChart) equipmentChart.destroy();
            equipmentChart = new Chart(document.getElementById('equipmentChart'), {
                type: 'bar',
                data: {
                    labels: equipLabels,
                    datasets: [
                        { label: 'ä½¿ç”¨', data: equipWork, backgroundColor: '#10b981', borderRadius: 4 },
                        { label: 'ç©ºé—²', data: equipIdle, backgroundColor: '#374151', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { stacked: true, ticks: { color: '#9ca3af' }, grid: { color: '#374151' } },
                        y: { stacked: true, ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }
                    },
                    plugins: { legend: { labels: { color: '#9ca3af' } } }
                }
            });
            
            const fatigueSelect = document.getElementById('fatigueWorkerSelect');
            fatigueSelect.innerHTML = '<option value="all">å…¨éƒ¨å·¥äºº</option>';
            const fatigueData = result.worker_fatigue_data || result.worker_stats || [];
            fatigueData.forEach(w => {
                const workerId = w.worker_id || w.resource_id;
                fatigueSelect.innerHTML += `<option value="${workerId}">${workerId}</option>`;
            });
            
            updateFatigueChart();
            initGanttControls(result);
        }
        
        function updateComparisonTable(result) {
            const comparison = result.no_rest_comparison || {};
            const tbody = document.getElementById('comparisonBody');
            
            if (!comparison.engines_completed) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">å¯¹æ¯”æ•°æ®ä¸å¯ç”¨</td></tr>';
                return;
            }
            
            const rows = [
                {
                    label: 'å®Œæˆå‘åŠ¨æœºæ•°',
                    withRest: result.engines_completed,
                    noRest: comparison.engines_completed,
                    unit: 'å°',
                    higherBetter: true
                },
                {
                    label: 'å¹³å‡å‘¨æœŸæ—¶é—´',
                    withRest: (result.avg_cycle_time / 60).toFixed(1),
                    noRest: (comparison.avg_cycle_time / 60).toFixed(1),
                    unit: 'å°æ—¶',
                    higherBetter: false
                },
                {
                    label: 'å¹³å‡å·¥äººåˆ©ç”¨ç‡',
                    withRest: ((result.worker_stats.reduce((s, w) => s + w.utilization_rate, 0) / result.worker_stats.length) * 100).toFixed(1),
                    noRest: (comparison.avg_worker_utilization * 100).toFixed(1),
                    unit: '%',
                    higherBetter: true
                },
                {
                    label: 'æ€»ä¼‘æ¯æ—¶é—´',
                    withRest: (result.human_factors_stats?.total_rest_time || 0).toFixed(0),
                    noRest: 0,
                    unit: 'åˆ†é’Ÿ',
                    higherBetter: null
                },
                {
                    label: 'ä¸€æ¬¡é€šè¿‡ç‡',
                    withRest: (result.quality_stats.first_pass_rate * 100).toFixed(1),
                    noRest: (comparison.first_pass_rate * 100).toFixed(1),
                    unit: '%',
                    higherBetter: true
                }
            ];
            
            tbody.innerHTML = rows.map(row => {
                const diff = parseFloat(row.withRest) - parseFloat(row.noRest);
                let diffClass = '';
                let diffText = diff > 0 ? `+${diff.toFixed(1)}` : diff.toFixed(1);
                
                if (row.higherBetter !== null) {
                    if ((row.higherBetter && diff > 0) || (!row.higherBetter && diff < 0)) {
                        diffClass = 'comparison-better';
                    } else if (diff !== 0) {
                        diffClass = 'comparison-worse';
                    }
                }
                
                return `<tr>
                    <td>${row.label}</td>
                    <td>${row.withRest} ${row.unit}</td>
                    <td>${row.noRest} ${row.unit}</td>
                    <td class="${diffClass}">${diffText} ${row.unit}</td>
                </tr>`;
            }).join('');
        }
        
        function updateFatigueChart() {
            if (!state.simulationResult) return;
            
            const selectedWorker = document.getElementById('fatigueWorkerSelect').value;
            const fatigueData = state.simulationResult.worker_fatigue_data || state.simulationResult.worker_stats || [];
            
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
            
            let datasets = [];
            
            if (selectedWorker === 'all') {
                datasets = fatigueData.map((worker, idx) => {
                    const workerId = worker.worker_id || worker.resource_id;
                    const history = worker.fatigue_history || [];
                    
                    if (history.length > 0) {
                        return {
                            label: workerId,
                            data: history.map(h => ({ x: h[0], y: h[1] })),
                            borderColor: colors[idx % colors.length],
                            backgroundColor: 'transparent',
                            tension: 0.3,
                            pointRadius: 0
                        };
                    } else {
                        return {
                            label: workerId,
                            data: [{ x: 0, y: 0 }, { x: state.simulationResult.sim_duration, y: worker.fatigue_level || 0 }],
                            borderColor: colors[idx % colors.length],
                            backgroundColor: 'transparent',
                            tension: 0,
                            pointRadius: 2
                        };
                    }
                });
            } else {
                const worker = fatigueData.find(w => (w.worker_id || w.resource_id) === selectedWorker);
                if (worker) {
                    const history = worker.fatigue_history || [];
                    if (history.length > 0) {
                        datasets = [{
                            label: selectedWorker,
                            data: history.map(h => ({ x: h[0], y: h[1] })),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2
                        }];
                    } else {
                        datasets = [{
                            label: selectedWorker,
                            data: [{ x: 0, y: 0 }, { x: state.simulationResult.sim_duration, y: worker.fatigue_level || 0 }],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0,
                            pointRadius: 4
                        }];
                    }
                }
            }
            
            if (fatigueChart) fatigueChart.destroy();
            fatigueChart = new Chart(document.getElementById('fatigueChart'), {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    scales: {
                        x: { 
                            type: 'linear',
                            title: { display: true, text: 'æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰', color: '#9ca3af' },
                            ticks: { color: '#9ca3af' }, 
                            grid: { color: '#374151' } 
                        },
                        y: { 
                            min: 0, 
                            max: 100,
                            title: { display: true, text: 'ç–²åŠ³åº¦', color: '#9ca3af' },
                            ticks: { color: '#9ca3af' }, 
                            grid: { color: '#374151' } 
                        }
                    },
                    plugins: { 
                        legend: { 
                            display: selectedWorker === 'all',
                            labels: { color: '#9ca3af' } 
                        } 
                    }
                }
            });
        }
        
        // ============================================================
        // Gantt Chart - ä¼˜åŒ–ç‰ˆï¼šè‡ªé€‚åº”å®½åº¦ + å¢å¤§è¡Œé«˜
        // ============================================================
        function initGanttControls(result) {
            const config = getConfigFromUI();
            const totalDays = config.work_days_per_month;
            const hoursPerDay = config.work_hours_per_day;
            
            const startDaySelect = document.getElementById('ganttStartDay');
            const endDaySelect = document.getElementById('ganttEndDay');
            const startHourSelect = document.getElementById('ganttStartHour');
            const endHourSelect = document.getElementById('ganttEndHour');
            
            startDaySelect.innerHTML = '';
            endDaySelect.innerHTML = '';
            for (let d = 1; d <= totalDays; d++) {
                startDaySelect.innerHTML += `<option value="${d}">ç¬¬${d}å¤©</option>`;
                endDaySelect.innerHTML += `<option value="${d}">ç¬¬${d}å¤©</option>`;
            }
            
            const actualDays = Math.ceil(result.sim_duration / (hoursPerDay * 60));
            endDaySelect.value = Math.min(Math.max(actualDays, 3), totalDays);
            
            startHourSelect.innerHTML = '';
            endHourSelect.innerHTML = '';
            for (let h = 0; h < hoursPerDay; h++) {
                startHourSelect.innerHTML += `<option value="${h}">${h}:00</option>`;
                endHourSelect.innerHTML += `<option value="${h+1}">${h+1}:00</option>`;
            }
            endHourSelect.value = hoursPerDay;
            
            updateGantt();
        }
        
        function updateGantt() {
            if (!state.simulationResult) {
                showToast('è¯·å…ˆè¿è¡Œä»¿çœŸ', 'warning');
                return;
            }
            
            const config = getConfigFromUI();
            const hoursPerDay = config.work_hours_per_day;
            const minutesPerDay = hoursPerDay * 60;
            
            const startDay = parseInt(document.getElementById('ganttStartDay').value);
            const startHour = parseInt(document.getElementById('ganttStartHour').value);
            const endDay = parseInt(document.getElementById('ganttEndDay').value);
            const endHour = parseInt(document.getElementById('ganttEndHour').value);
            
            const startMinute = (startDay - 1) * minutesPerDay + startHour * 60;
            const endMinute = (endDay - 1) * minutesPerDay + endHour * 60;
            const totalMinutes = endMinute - startMinute;
            
            // ===== è®¡ç®—hourWidth =====
            const engineRight = document.getElementById('engineGanttRight');
            const availableWidth = engineRight ? (engineRight.clientWidth - 20) : 800;
            
            const totalHours = totalMinutes / 60;
            // æœ€å°30pxä¿è¯å¯è¯»æ€§ï¼Œæ— ä¸Šé™è®©å…¶è‡ªé€‚åº”
            const hourWidth = Math.max(30, availableWidth / totalHours);
            
            renderTimeline('ganttTimeline', startDay, startHour, endDay, endHour, hoursPerDay, hourWidth);
            renderTimeline('workerGanttTimeline', startDay, startHour, endDay, endHour, hoursPerDay, hourWidth);
            
            renderEngineGantt(startMinute, endMinute, hoursPerDay, hourWidth);
            renderWorkerGantt(startMinute, endMinute, hoursPerDay, hourWidth);
            
            // è®¾ç½®æ»šåŠ¨åŒæ­¥
            setupScrollSync();
        }
        
        // è®¾ç½®å·¦å³ã€ä¸Šä¸‹æ»šåŠ¨åŒæ­¥
        function setupScrollSync() {
            // å‘åŠ¨æœºç”˜ç‰¹å›¾æ»šåŠ¨åŒæ­¥
            const engineLabels = document.getElementById('engineGanttLabels');
            const engineBody = document.getElementById('ganttBody');
            
            if (engineLabels && engineBody) {
                engineBody.onscroll = function() {
                    engineLabels.scrollTop = engineBody.scrollTop;
                };
                engineLabels.onscroll = function() {
                    engineBody.scrollTop = engineLabels.scrollTop;
                };
            }
            
            // å·¥äººç”˜ç‰¹å›¾æ»šåŠ¨åŒæ­¥
            const workerLabels = document.getElementById('workerGanttLabels');
            const workerBody = document.getElementById('workerGanttBody');
            
            if (workerLabels && workerBody) {
                workerBody.onscroll = function() {
                    workerLabels.scrollTop = workerBody.scrollTop;
                };
                workerLabels.onscroll = function() {
                    workerBody.scrollTop = workerLabels.scrollTop;
                };
            }
        }
        
        function renderTimeline(containerId, startDay, startHour, endDay, endHour, hoursPerDay, hourWidth) {
            const timeline = document.getElementById(containerId);
            timeline.innerHTML = '';
            
            for (let d = startDay; d <= endDay; d++) {
                const dayStartHour = d === startDay ? startHour : 0;
                const dayEndHour = d === endDay ? endHour : hoursPerDay;
                
                for (let h = dayStartHour; h < dayEndHour; h++) {
                    const cell = document.createElement('div');
                    cell.className = 'gantt-time-cell' + (h === 0 ? ' day-start' : '');
                    cell.style.width = hourWidth + 'px';
                    cell.style.minWidth = hourWidth + 'px';
                    cell.textContent = `D${d} ${h}h`;
                    timeline.appendChild(cell);
                }
            }
        }
        
        function renderEngineGantt(startMinute, endMinute, hoursPerDay, hourWidth) {
            const events = state.simulationResult.gantt_events.filter(e => 
                e.end_time > startMinute && e.start_time < endMinute
            );
            
            const totalWidth = (endMinute - startMinute) / 60 * hourWidth;
            
            const engineGroups = {};
            events.forEach(e => {
                const key = `Engine ${e.engine_id}`;
                if (!engineGroups[key]) engineGroups[key] = [];
                engineGroups[key].push(e);
            });
            
            const labels = document.getElementById('engineGanttLabels');
            const body = document.getElementById('ganttBody');
            labels.innerHTML = '';
            body.innerHTML = '';
            
            const sortedEngines = Object.entries(engineGroups).sort((a, b) => {
                return parseInt(a[0].split(' ')[1]) - parseInt(b[0].split(' ')[1]);
            });
            
            sortedEngines.forEach(([label, evts]) => {
                // å·¦ä¾§æ ‡ç­¾
                const labelRow = document.createElement('div');
                labelRow.className = 'gantt-left-row';
                labelRow.textContent = label;
                labels.appendChild(labelRow);
                
                // å³ä¾§å†…å®¹
                const row = document.createElement('div');
                row.className = 'gantt-row';
                
                const rowContent = document.createElement('div');
                rowContent.className = 'gantt-row-content';
                rowContent.style.width = totalWidth + 'px';
                
                evts.forEach(evt => {
                    const bar = createGanttBar(evt, startMinute, endMinute, hourWidth);
                    rowContent.appendChild(bar);
                });
                
                row.appendChild(rowContent);
                body.appendChild(row);
            });
        }
        
        function renderWorkerGantt(startMinute, endMinute, hoursPerDay, hourWidth) {
            const events = state.simulationResult.gantt_events.filter(e => 
                e.end_time > startMinute && e.start_time < endMinute
            );
            
            const totalWidth = (endMinute - startMinute) / 60 * hourWidth;
            
            const workerGroups = {};
            events.forEach(e => {
                if (e.worker_ids && e.worker_ids.length > 0) {
                    e.worker_ids.forEach(workerId => {
                        if (!workerGroups[workerId]) workerGroups[workerId] = [];
                        workerGroups[workerId].push({ ...e, displayWorker: workerId });
                    });
                }
            });
            
            const labels = document.getElementById('workerGanttLabels');
            const body = document.getElementById('workerGanttBody');
            labels.innerHTML = '';
            body.innerHTML = '';
            
            const sortedWorkers = Object.keys(workerGroups).sort((a, b) => {
                return parseInt(a.replace(/\D/g, '')) - parseInt(b.replace(/\D/g, ''));
            });
            
            const config = getConfigFromUI();
            
            // å…ˆæ¸²æŸ“æœ‰ä»»åŠ¡çš„å·¥äºº
            sortedWorkers.forEach(workerId => {
                // å·¦ä¾§æ ‡ç­¾
                const labelRow = document.createElement('div');
                labelRow.className = 'gantt-left-row';
                labelRow.textContent = workerId;
                labels.appendChild(labelRow);
                
                // å³ä¾§å†…å®¹
                const row = document.createElement('div');
                row.className = 'gantt-row';
                
                const rowContent = document.createElement('div');
                rowContent.className = 'gantt-row-content';
                rowContent.style.width = totalWidth + 'px';
                
                workerGroups[workerId].forEach(evt => {
                    const bar = createGanttBar(evt, startMinute, endMinute, hourWidth, true);
                    rowContent.appendChild(bar);
                });
                
                row.appendChild(rowContent);
                body.appendChild(row);
            });
            
            // æ¸²æŸ“æ²¡æœ‰ä»»åŠ¡çš„å·¥äºº
            for (let i = 1; i <= config.num_workers; i++) {
                const workerId = `Worker_${String(i).padStart(2, '0')}`;
                if (!workerGroups[workerId]) {
                    // å·¦ä¾§æ ‡ç­¾
                    const labelRow = document.createElement('div');
                    labelRow.className = 'gantt-left-row';
                    labelRow.textContent = workerId;
                    labelRow.style.color = '#6b7280';
                    labels.appendChild(labelRow);
                    
                    // å³ä¾§å†…å®¹
                    const row = document.createElement('div');
                    row.className = 'gantt-row';
                    
                    const rowContent = document.createElement('div');
                    rowContent.className = 'gantt-row-content';
                    rowContent.style.width = totalWidth + 'px';
                    rowContent.innerHTML = '<span style="color: #6b7280; font-size: 0.75rem; padding-left: 10px;">ï¼ˆæœ¬æ—¶æ®µæ— ä»»åŠ¡ï¼‰</span>';
                    
                    row.appendChild(rowContent);
                    body.appendChild(row);
                }
            }
        }
        
        function createWorkerGanttRow(workerId, events, startMinute, endMinute, hourWidth, totalWidth) {
            // æ­¤å‡½æ•°å·²åºŸå¼ƒï¼Œé€»è¾‘å·²åˆå¹¶åˆ°renderWorkerGanttä¸­
            return null;
        }
        
        function createGanttBar(evt, startMinute, endMinute, hourWidth, isWorkerView = false) {
            const bar = document.createElement('div');
            const eventType = evt.event_type.toLowerCase();
            bar.className = 'gantt-bar ' + eventType;
            
            const evtStart = Math.max(evt.start_time, startMinute);
            const evtEnd = Math.min(evt.end_time, endMinute);
            
            const left = (evtStart - startMinute) / 60 * hourWidth;
            const width = Math.max((evtEnd - evtStart) / 60 * hourWidth, 6);
            
            bar.style.left = left + 'px';
            bar.style.width = width + 'px';
            
            const duration = (evt.end_time - evt.start_time).toFixed(0);
            let tooltipText = `${evt.task_name}\næ—¶é—´: ${evt.start_time.toFixed(0)}-${evt.end_time.toFixed(0)}åˆ†é’Ÿ (${duration}åˆ†é’Ÿ)\nç±»å‹: ${evt.event_type}`;
            if (evt.rework_count > 0) tooltipText += `\nè¿”å·¥æ¬¡æ•°: ${evt.rework_count}`;
            if (!isWorkerView && evt.worker_ids && evt.worker_ids.length > 0) {
                tooltipText += `\nå·¥äºº: ${evt.worker_ids.join(', ')}`;
            }
            if (isWorkerView) tooltipText += `\nå‘åŠ¨æœº: Engine ${evt.engine_id}`;
            bar.title = tooltipText;
            
            // æ ¹æ®å®½åº¦å†³å®šæ˜¾ç¤ºå†…å®¹
            if (width > 50) {
                bar.textContent = isWorkerView ? `E${evt.engine_id}` : evt.step_id;
            } else if (width > 30) {
                bar.textContent = isWorkerView ? evt.engine_id : evt.step_id.slice(-3);
            }
            
            return bar;
        }
        
        function exportGanttCSV() {
            if (!state.simulationResult) {
                showToast('è¯·å…ˆè¿è¡Œä»¿çœŸ', 'warning');
                return;
            }
            
            let csv = 'engine_id,step_id,task_name,event_type,start_time,end_time,duration,workers\n';
            state.simulationResult.gantt_events.forEach(e => {
                csv += `${e.engine_id},${e.step_id},"${e.task_name}",${e.event_type},${e.start_time},${e.end_time},${e.end_time - e.start_time},"${(e.worker_ids || []).join(';')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gantt_chart.csv';
            a.click();
            URL.revokeObjectURL(url);
            showToast('ç”˜ç‰¹å›¾CSVå·²å¯¼å‡º', 'success');
        }
        
        // ============================================================
        // Tabs - æ§åˆ¶ä¾§è¾¹æ æ˜¾ç¤º
        // ============================================================
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
        }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            const sidebar = document.getElementById('sidebar');
            if (tabId === 'editor') {
                sidebar.classList.add('visible');
            } else {
                sidebar.classList.remove('visible');
            }
            
            if (tabId === 'editor') resizeCanvas();
            if (tabId === 'gantt' && state.simulationResult) {
                // å»¶è¿Ÿæ›´æ–°ä»¥ç¡®ä¿å®¹å™¨å·²æ¸²æŸ“
                setTimeout(updateGantt, 50);
            }
        }
        
        // ============================================================
        // Toolbox
        // ============================================================
        function initToolbox() {
            document.querySelectorAll('.toolbox-item').forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', item.dataset.type);
                });
            });
        }
        
        // ============================================================
        // UI Helpers
        // ============================================================
        function updateStats() {
            document.getElementById('nodeCount').textContent = state.nodes.length;
            document.getElementById('edgeCount').textContent = state.edges.length;
        }
        
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // ============================================================
        // Initialize
        // ============================================================
        document.addEventListener('DOMContentLoaded', () => {
            initCanvas();
            initTabs();
            initToolbox();
            initConfig();
            
            // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¡ç®—ç”˜ç‰¹å›¾
            window.addEventListener('resize', () => {
                if (state.simulationResult && document.getElementById('tab-gantt').classList.contains('active')) {
                    updateGantt();
                }
            });
        });
    </script>
</body>
</html>