<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>航空发动机装配排产仿真系统 - 北京航空航天大学</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header class="header">
        <h1>🛫 航空发动机装配排产仿真系统</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="importCSV()">📥 导入CSV</button>
            <button class="btn btn-secondary" onclick="exportCSV()">📤 导出CSV</button>
            <button class="btn btn-success" onclick="runSimulation()">▶️ 运行仿真</button>
        </div>
    </header>
    
    <div class="tabs">
        <div class="tab active" data-tab="editor">📐 流程编辑</div>
        <div class="tab" data-tab="config">⚙️ 参数配置</div>
        <div class="tab" data-tab="results">📊 仿真结果</div>
        <div class="tab" data-tab="gantt">📅 甘特图</div>
    </div>
    
    <div class="main-container">
        <aside class="sidebar visible" id="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">🧰 节点工具箱</div>
                <div class="toolbox-item" draggable="true" data-type="H">
                    <div class="toolbox-icon" style="background: #3b82f6;">📦</div>
                    <div class="toolbox-info">
                        <h4>取/放 (H)</h4>
                        <span>Handling</span>
                    </div>
                </div>
                <div class="toolbox-item" draggable="true" data-type="A">
                    <div class="toolbox-icon" style="background: #10b981;">🔧</div>
                    <div class="toolbox-info">
                        <h4>装配 (A)</h4>
                        <span>Assembly</span>
                    </div>
                </div>
                <div class="toolbox-item" draggable="true" data-type="M">
                    <div class="toolbox-icon" style="background: #f59e0b;">📏</div>
                    <div class="toolbox-info">
                        <h4>测量 (M)</h4>
                        <span>Measurement</span>
                    </div>
                </div>
                <div class="toolbox-item" draggable="true" data-type="T">
                    <div class="toolbox-icon" style="background: #8b5cf6;">🛠️</div>
                    <div class="toolbox-info">
                        <h4>工具操作 (T)</h4>
                        <span>Tooling</span>
                    </div>
                </div>
                <div class="toolbox-item" draggable="true" data-type="D">
                    <div class="toolbox-icon" style="background: #6b7280;">📝</div>
                    <div class="toolbox-info">
                        <h4>数据记录 (D)</h4>
                        <span>Data Recording</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">📋 操作说明</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.6;">
                    <p>• 拖拽节点到画布创建</p>
                    <p>• 双击节点编辑属性</p>
                    <p>• <b>右键拖拽创建连线</b></p>
                    <p>• Delete键删除选中</p>
                    <p>• 滚轮缩放画布</p>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">📊 流程统计</div>
                <div id="processStats" style="font-size: 0.875rem;">
                    <p>节点数: <span id="nodeCount">0</span></p>
                    <p>连线数: <span id="edgeCount">0</span></p>
                </div>
            </div>
        </aside>
        
        <main class="content">
            <!-- Tab: Editor -->
            <div id="tab-editor" class="tab-content active">
                <div class="canvas-container">
                    <div class="canvas-toolbar">
                        <button class="btn btn-secondary" onclick="autoLayout()">🔄 自动布局</button>
                        <button class="btn btn-secondary" onclick="autoLayoutByStation()">📍 按工位布局</button>
                        <select id="stationFilter" onchange="filterByStation()" style="padding: 0.5rem; border-radius: 6px; background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color);">
                            <option value="">全部工位</option>
                        </select>
                        <label style="display: flex; align-items: center; gap: 0.3rem; font-size: 0.875rem; color: var(--text-secondary);">
                            <input type="checkbox" id="showContainers" checked onchange="toggleContainers()"> 显示工位容器
                        </label>
                        <button class="btn btn-secondary" id="layoutModeToggle" onclick="toggleLayoutMode()">🏢 工位层级视图</button>
                        <button class="btn btn-secondary" onclick="clearCanvas()">🗑️ 清空</button>
                        <button class="btn btn-primary" onclick="loadComplexExample()">📋 加载复杂示例</button>
                    </div>
                    <canvas id="processCanvas"></canvas>
                </div>
            </div>
            
            <!-- Tab: Config -->
            <div id="tab-config" class="tab-content">
                <div class="card">
                    <h3 class="card-title">⏰ 排班配置</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>每日工作小时数</label>
                            <input type="number" id="workHoursPerDay" value="8" min="1" max="24">
                        </div>
                        <div class="form-group">
                            <label>每月工作天数</label>
                            <input type="number" id="workDaysPerMonth" value="22" min="1" max="31">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>工人数量</label>
                            <input type="number" id="numWorkers" value="8" min="1">
                        </div>
                        <div class="form-group">
                            <label>目标月产量（台）</label>
                            <input type="number" id="targetOutput" value="3" min="1">
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">🔧 关键设备配置</h3>
                    <div id="equipmentList" class="equipment-list"></div>
                    <div class="form-row" style="margin-top: 1rem;">
                        <div class="form-group" style="flex: 1;">
                            <label>设备名称</label>
                            <input type="text" id="newEquipmentName" placeholder="输入设备名称" style="width: 100%;">
                        </div>
                        <div class="form-group" style="width: 120px;">
                            <label>数量</label>
                            <input type="number" id="newEquipmentCount" value="1" min="1" style="width: 100%;">
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="addEquipment()">➕ 添加设备</button>
                </div>
                
                <div class="card">
                    <h3 class="card-title">⚙️ 高级配置</h3>
                    <div class="form-row">
                        <div class="form-group" style="flex-direction: row; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="pipelineMode" checked style="width: auto;">
                            <label for="pipelineMode" style="margin-bottom: 0;">启用流水线模式 (多台并行)</label>
                        </div>
                        <div class="form-group" style="flex-direction: row; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="stationConstraintMode" style="width: auto;">
                            <label for="stationConstraintMode" style="margin-bottom: 0;">启用工位资源限制 (工位内强制串行)</label>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">😴 休息规则配置</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>连续工作触发阈值（分钟）</label>
                            <input type="number" id="restTimeThreshold" value="50" min="1">
                        </div>
                        <div class="form-group">
                            <label>时间触发休息时长（分钟）</label>
                            <input type="number" id="restDurationTime" value="5" min="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>负荷触发阈值（REBA 1-10）</label>
                            <input type="number" id="restLoadThreshold" value="7" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label>负荷触发休息时长（分钟）</label>
                            <input type="number" id="restDurationLoad" value="3" min="1">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Results -->
            <div id="tab-results" class="tab-content">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">月产量</div>
                        <div class="kpi-value"><span id="kpiEngines">-</span><span class="kpi-unit">台</span></div>
                    </div>
                    <div class="kpi-card green">
                        <div class="kpi-label">计划达成率</div>
                        <div class="kpi-value"><span id="kpiAchievement">-</span><span class="kpi-unit">%</span></div>
                    </div>
                    <div class="kpi-card orange">
                        <div class="kpi-label">平均周期时间</div>
                        <div class="kpi-value"><span id="kpiCycleTime">-</span><span class="kpi-unit">小时</span></div>
                    </div>
                    <div class="kpi-card purple">
                        <div class="kpi-label">一次通过率</div>
                        <div class="kpi-value"><span id="kpiPassRate">-</span><span class="kpi-unit">%</span></div>
                    </div>
                    <div class="kpi-card red">
                        <div class="kpi-label">总休息时间</div>
                        <div class="kpi-value"><span id="kpiRestTime">-</span><span class="kpi-unit">分钟</span></div>
                    </div>
                    <div class="kpi-card cyan">
                        <div class="kpi-label">高强度任务暴露</div>
                        <div class="kpi-value"><span id="kpiHighIntensity">-</span><span class="kpi-unit">次</span></div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">🔄 人因影响对比（考虑休息 vs 不考虑休息）</h3>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>指标</th>
                                <th>考虑人因（有休息）</th>
                                <th>不考虑人因（无休息）</th>
                                <th>差异</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonBody">
                            <tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">运行仿真后显示对比数据</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">👷 工人利用率（分钟）</div>
                        <canvas id="workerChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">🏭 设备利用率（分钟）</div>
                        <canvas id="equipmentChart"></canvas>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 1rem;">
                    <div class="chart-header">
                        <h3 class="card-title" style="margin-bottom: 0;">😓 工人疲劳度曲线</h3>
                        <select id="fatigueWorkerSelect" onchange="updateFatigueChart()">
                            <option value="all">全部工人</option>
                        </select>
                    </div>
                    <canvas id="fatigueChart" style="max-height: 300px;"></canvas>
                </div>
                
                <div class="card" style="margin-top: 1rem;">
                    <h3 class="card-title">📈 质量统计</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">总检验次数</div>
                            <div style="font-size: 1.5rem; font-weight: 600;" id="statInspections">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">总返工次数</div>
                            <div style="font-size: 1.5rem; font-weight: 600; color: var(--accent-red);" id="statReworks">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">返工时间</div>
                            <div style="font-size: 1.5rem; font-weight: 600;" id="statReworkTime">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">仿真时长</div>
                            <div style="font-size: 1.5rem; font-weight: 600;" id="statDuration">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- 瓶颈分析模块 -->
                <div class="card" style="margin-top: 1rem;">
                    <h3 class="card-title">🚧 生产瓶颈分析</h3>
                    <div id="bottleneckLoading" style="text-align: center; color: var(--text-secondary); padding: 1rem;">
                        运行仿真后显示瓶颈分析
                    </div>
                    <div id="bottleneckContent" style="display: none;">
                        <!-- 瓶颈汇总 -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">总瓶颈数</div>
                                <div style="font-size: 1.5rem; font-weight: 600;" id="bottleneckTotal">0</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: rgba(239,68,68,0.1); border-radius: 8px; border: 1px solid var(--accent-red);">
                                <div style="font-size: 0.75rem; color: var(--accent-red);">高严重性</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: var(--accent-red);" id="bottleneckHigh">0</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: rgba(245,158,11,0.1); border-radius: 8px; border: 1px solid var(--accent-orange);">
                                <div style="font-size: 0.75rem; color: var(--accent-orange);">中严重性</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: var(--accent-orange);" id="bottleneckMedium">0</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: rgba(16,185,129,0.1); border-radius: 8px; border: 1px solid var(--accent-green);">
                                <div style="font-size: 0.75rem; color: var(--accent-green);">效率评分</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: var(--accent-green);" id="efficiencyScore">-</div>
                            </div>
                        </div>
                        
                        <!-- 瓶颈详情列表 -->
                        <div id="bottleneckList" style="max-height: 300px; overflow-y: auto;"></div>
                        
                        <!-- 改进建议 -->
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-cyan);">💡 改进建议</div>
                            <div id="bottleneckRecommendations" style="font-size: 0.875rem; color: var(--text-secondary);"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 设备分类显示 -->
                <div class="card" style="margin-top: 1rem;">
                    <h3 class="card-title">🏭 设备使用详情</h3>
                    <div id="equipmentDetailLoading" style="text-align: center; color: var(--text-secondary); padding: 1rem;">
                        运行仿真后显示设备详情
                    </div>
                    <div id="equipmentDetailContent" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <!-- 关键设备 -->
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-orange);">⚠️ 关键设备（有数量限制）</div>
                                <div id="criticalEquipmentList" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            <!-- 无限制设备 -->
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-green);">✅ 无限制设备（默认充足）</div>
                                <div id="unlimitedEquipmentList" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 工位统计分析模块 -->
                <div class="card" style="margin-top: 1rem;">
                    <h3 class="card-title">📍 工位统计分析</h3>
                    <div id="stationAnalysisLoading" style="text-align: center; color: var(--text-secondary); padding: 1rem;">
                        运行仿真后显示工位分析
                    </div>
                    <div id="stationAnalysisContent" style="display: none;">
                        <!-- 工位汇总统计 -->
                        <div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-purple);">📊 工位汇总</div>
                            <div id="stationSummaryList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem;"></div>
                        </div>
                        
                        <!-- 工位瓶颈排名 -->
                        <div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-orange);">🔥 工位瓶颈TOP</div>
                            <div id="stationBottleneckList" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                        
                        <!-- 工位流转矩阵 -->
                        <div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-cyan);">🔄 工位流转分析</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">流转TOP路径</div>
                                    <div id="stationFlowTopPaths" style="max-height: 150px; overflow-y: auto;"></div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">流转矩阵</div>
                                    <div id="stationFlowMatrix" style="max-height: 200px; overflow: auto;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Gantt -->
            <div id="tab-gantt" class="tab-content">
                <div class="gantt-controls">
                    <span>时间范围:</span>
                    <select id="ganttStartDay"></select>
                    <select id="ganttStartHour"></select>
                    <span>至</span>
                    <select id="ganttEndDay"></select>
                    <select id="ganttEndHour"></select>
                    <button class="btn btn-primary" onclick="updateGantt()">🔄 刷新</button>
                    <button class="btn btn-secondary" onclick="exportGanttCSV()">📤 导出CSV</button>
                </div>
                
                <div class="gantt-section">
                    <div class="gantt-section-title">🏭 生产进度甘特图（按发动机）</div>
                    <div class="gantt-container" id="engineGanttContainer">
                        <div class="gantt-wrapper">
                            <div class="gantt-left">
                                <div class="gantt-left-header">发动机</div>
                                <div class="gantt-left-body" id="engineGanttLabels"></div>
                            </div>
                            <div class="gantt-right" id="engineGanttRight">
                                <div class="gantt-right-inner">
                                    <div class="gantt-header">
                                        <div class="gantt-timeline" id="ganttTimeline"></div>
                                    </div>
                                    <div class="gantt-body" id="ganttBody"></div>
                                </div>
                            </div>
                        </div>
                        <div class="gantt-legend">
                            <div class="legend-item"><div class="legend-color normal"></div><span>正常工作</span></div>
                            <div class="legend-item"><div class="legend-color rest"></div><span>休息</span></div>
                            <div class="legend-item"><div class="legend-color rework"></div><span>返工</span></div>
                            <div class="legend-item"><div class="legend-color waiting"></div><span>等待资源</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="gantt-section">
                    <div class="gantt-section-title">👷 工人排产甘特图（按工人）</div>
                    <div class="gantt-container" id="workerGanttContainer">
                        <div class="gantt-wrapper">
                            <div class="gantt-left">
                                <div class="gantt-left-header">工人</div>
                                <div class="gantt-left-body" id="workerGanttLabels"></div>
                            </div>
                            <div class="gantt-right" id="workerGanttRight">
                                <div class="gantt-right-inner">
                                    <div class="gantt-header">
                                        <div class="gantt-timeline" id="workerGanttTimeline"></div>
                                    </div>
                                    <div class="gantt-body" id="workerGanttBody"></div>
                                </div>
                            </div>
                        </div>
                        <div class="gantt-legend">
                            <div class="legend-item"><div class="legend-color normal"></div><span>工作中</span></div>
                            <div class="legend-item"><div class="legend-color rest"></div><span>休息中</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Node Edit Modal -->
    <div class="modal-overlay" id="nodeModal">
        <div class="modal">
            <div class="modal-header">
                <h3>📝 编辑节点属性</h3>
                <button class="modal-close" onclick="closeNodeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>步骤ID *</label>
                        <input type="text" id="nodeStepId" placeholder="如: S001">
                    </div>
                    <div class="form-group">
                        <label>操作类型 *</label>
                        <select id="nodeOpType">
                            <option value="H">H - 取/放</option>
                            <option value="A">A - 装配</option>
                            <option value="M">M - 测量</option>
                            <option value="T">T - 工具操作</option>
                            <option value="D">D - 数据记录</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>任务名称 *</label>
                    <input type="text" id="nodeTaskName" placeholder="如: 低压压气机装配">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>标准工时（分钟）</label>
                        <input type="number" id="nodeStdDuration" value="30" min="1">
                    </div>
                    <div class="form-group">
                        <label>时间方差</label>
                        <input type="number" id="nodeTimeVariance" value="5" min="0" step="0.1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>负荷评分（REBA 1-10）</label>
                        <input type="number" id="nodeWorkLoad" value="5" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label>返工概率（仅M类型）</label>
                        <input type="number" id="nodeReworkProb" value="0.05" min="0" max="1" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>所需工人数</label>
                        <input type="number" id="nodeWorkers" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>所需工具（分号分隔）</label>
                        <input type="text" id="nodeTools" placeholder="如: 动平衡机;扭力扳手">
                    </div>
                </div>
                <div class="form-group">
                    <label>前置依赖（分号分隔）</label>
                    <input type="text" id="nodePredecessors" placeholder="如: S001;S002">
                </div>
                <div class="form-group">
                    <label>工位 *</label>
                    <select id="nodeStation" required>
                        <option value="">-- 请选择工位 --</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeNodeModal()">取消</button>
                <button class="btn btn-danger" onclick="deleteNode()">删除节点</button>
                <button class="btn btn-primary" onclick="saveNode()">保存</button>
            </div>
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>正在运行仿真...</div>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <div class="watermark">
        <div class="watermark-line">北京航空航天大学</div>
        <div class="watermark-line">Beihang University</div>
    </div>
    
    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
    <script src="js/config.js"></script>
    <script src="js/state.js"></script>
    <script src="js/data.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/canvas.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/layout.js"></script>
    <script src="js/csv.js"></script>
    <script src="js/simulation.js"></script>
    <script src="js/analysis.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/main.js"></script>
</body>
</html>
